<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Shift Planner</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 20px;
        }

        .calendar-header {
            font-weight: bold;
            text-align: center;
            padding: 10px;
            background-color: #f0f0f0;
        }

        .calendar-day {
            border: 1px solid #ddd;
            height: 150px; /* Fixed height */
            padding: 5px;
            cursor: pointer;
            position: relative;
            display: flex;
            flex-direction: column;
            transition: background-color 0.2s;
            overflow-y: auto;
        }

        .calendar-day:not(.empty):hover {
            background-color: #f0f0f0;
        }

        .calendar-day.empty {
            cursor: default;
            background-color: #f9f9f9;
        }

        .calendar-day .day-number {
            font-weight: bold;
            margin-bottom: 3px;
            font-size: 1em;
            flex-shrink: 0; /* Prevent day number from shrinking */
            position: sticky;
            top: 0;
            background-color: inherit;
            z-index: 1;
            padding-bottom: 3px;
        }

        .calendar-day .shift-info {
            font-size: 0.9em;
            line-height: 1.4;
            margin-top: 5px;
            overflow-y: auto; /* Enable vertical scrolling */
            flex-grow: 1; /* Take up remaining space */
            scrollbar-width: thin; /* For Firefox */
            scrollbar-color: #999 #f1f1f1; /* For Firefox */
        }

        /* Webkit scrollbar styling */
        .calendar-day .shift-info::-webkit-scrollbar {
            width: 6px;
        }

        .calendar-day .shift-info::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .calendar-day .shift-info::-webkit-scrollbar-thumb {
            background: #999;
            border-radius: 3px;
        }

        .calendar-day .shift-info::-webkit-scrollbar-thumb:hover {
            background: #777;
        }

        .calendar-day.weekend {
            background-color: #f9f9f9;
        }

        .calendar-day.today {
            border: 2px solid #4CAF50;
        }

        .calendar-day.filtered {
            background-color: #e6f3ff;
        }

        .assignment {
            margin: 2px 0;
            padding: 3px 5px;
            border-radius: 3px;
            font-size: 0.85em;
            word-wrap: break-word;
            line-height: 1.3;
        }

        .assignment.day {
            background-color: #e3f2fd;
            border: 1px solid #90caf9;
        }

        .assignment.night {
            background-color: #fff3e0;
            border: 1px solid #ffcc80;
        }

        .assignment.control {
            background-color: #e8eaf6;
            border: 1px solid #9fa8da;
        }

        .assignment.ambulance {
            background-color: #ffebee;
            border: 1px solid #ef9a9a;
        }

        .assignment.medical {
            background-color: #e8f5e9;
            border: 1px solid #a5d6a7;
        }

        .controls {
            margin: 20px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            min-width: 600px;
            max-width: 800px;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            z-index: 1001;
        }
        
        .transport-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .transport-buttons button {
            flex: 1;
            padding: 8px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .transport-buttons button:hover {
            background-color: #45a049;
        }

        .close {
            float: right;
            cursor: pointer;
            font-size: 20px;
        }

        button {
            padding: 8px 16px;
            margin: 0 5px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
        }

        button:hover {
            background-color: #45a049;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        .staff-list {
            margin-top: 20px;
        }

        .staff-search {
            margin-bottom: 8px;
            width: 100%;
            box-sizing: border-box;
            padding: 6px;
            font-size: 0.95em;
        }

        .staff-table-container {
            max-height: 220px;
            overflow: auto;
            border: 1px solid #ddd;
        }

        .leave-record {
            margin-bottom: 10px;
        }

        .leave-record button {
            margin-top: 5px;
            padding: 2px 8px;
            background-color: #ff4444;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .leave-record button:hover {
            background-color: #cc0000;
        }

        #leaveList {
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }

        /* Print Styles */
        @media print {
            /* Hide all buttons and controls when printing */
            .controls,
            button,
            .modal,
            #importFile {
                display: none !important;
            }

            /* Reset page margins and size */
            @page {
                size: landscape;
                margin: 0.5cm;
            }

            body {
                margin: 0;
                padding: 10px;
                font-size: 10pt;
            }

            .container {
                max-width: 100%;
                margin: 0;
            }

            h1 {
                font-size: 16pt;
                margin: 0 0 10px 0;
                text-align: center;
            }

            #currentMonth {
                display: block;
                text-align: center;
                font-size: 14pt;
                font-weight: bold;
                margin-bottom: 10px;
            }

            /* Calendar grid adjustments */
            .calendar {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 2px;
                margin-top: 10px;
                page-break-inside: avoid;
            }

            .calendar-header {
                padding: 5px;
                font-size: 10pt;
                font-weight: bold;
                text-align: center;
                background-color: #e0e0e0 !important;
                background: #e0e0e0 !important;
                border: 1px solid #000;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            .calendar-day {
                border: 1px solid #000;
                padding: 3px;
                height: auto;
                min-height: 80px;
                font-size: 8pt;
                overflow: visible;
                page-break-inside: avoid;
                background-color: #fff !important;
                background: #fff !important;
            }

            .calendar-day.empty {
                background-color: #f5f5f5 !important;
                background: #f5f5f5 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            .calendar-day.weekend {
                background-color: #f0f0f0 !important;
                background: #f0f0f0 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            .calendar-day.today {
                border: 2px solid #000 !important;
                font-weight: bold;
            }

            .calendar-day .day-number {
                font-size: 10pt;
                font-weight: bold;
                margin-bottom: 3px;
                position: static;
                padding-bottom: 2px;
                border-bottom: 1px solid #ccc;
            }

            .calendar-day .shift-info {
                font-size: 7pt;
                line-height: 1.3;
                margin-top: 3px;
                overflow: visible;
            }

            /* Assignment styling for print */
            .assignment {
                margin: 2px 0;
                padding: 2px 3px;
                border-radius: 2px;
                font-size: 7pt;
                line-height: 1.2;
                border: 1px solid #000 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            .assignment.day {
                background-color: #cfe2f3 !important;
                background: #cfe2f3 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            .assignment.night {
                background-color: #fff2cc !important;
                background: #fff2cc !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            .assignment.control {
                background-color: #d9d2e9 !important;
                background: #d9d2e9 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            .assignment.ambulance {
                background-color: #f4cccc !important;
                background: #f4cccc !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            .assignment.medical {
                background-color: #d9ead3 !important;
                background: #d9ead3 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            /* Print legend */
            .print-legend {
                display: block !important;
                margin: 10px 0;
                padding: 5px;
                border: 1px solid #000;
                font-size: 8pt;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            .print-legend h3 {
                margin: 0 0 5px 0;
                font-size: 10pt;
            }

            .print-legend-item {
                display: inline-block;
                margin-right: 15px;
                padding: 2px 5px;
                border-radius: 2px;
                border: 1px solid #000;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
        }

        /* Print legend - hidden on screen */
        .print-legend {
            display: none;
        }

        /* Shift Swap Styles */
        .swap-request {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }

        .swap-request.pending {
            border-left: 4px solid #ff9800;
        }

        .swap-request.approved {
            border-left: 4px solid #4CAF50;
            background-color: #e8f5e9;
        }

        .swap-request.rejected {
            border-left: 4px solid #f44336;
            background-color: #ffebee;
        }

        .swap-request-header {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .swap-request-details {
            font-size: 0.9em;
            margin: 5px 0;
        }

        .swap-request-actions {
            margin-top: 8px;
        }

        .swap-request-actions button {
            margin-right: 5px;
            padding: 4px 12px;
            font-size: 0.9em;
        }

        .swap-history-container {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 10px;
        }

        /* Staff Availability Styles */
        .availability-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        .availability-table th,
        .availability-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }

        .availability-table th {
            background-color: #f2f2f2;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .availability-table th.staff-name {
            position: sticky;
            left: 0;
            z-index: 11;
            background-color: #e0e0e0;
            text-align: left;
            min-width: 150px;
        }

        .availability-table td.staff-name {
            position: sticky;
            left: 0;
            background-color: #f9f9f9;
            font-weight: bold;
            text-align: left;
            z-index: 5;
        }

        .availability-cell {
            min-width: 40px;
            height: 35px;
            cursor: help;
        }

        .availability-cell.available {
            background-color: #4CAF50;
            color: white;
        }

        .availability-cell.scheduled {
            background-color: #FFC107;
            color: black;
        }

        .availability-cell.on-leave {
            background-color: #F44336;
            color: white;
        }

        .availability-cell.weekend {
            background-color: #e0e0e0;
        }

        .availability-cell:hover {
            opacity: 0.8;
            transform: scale(1.05);
            transition: all 0.2s;
        }

        .day-header {
            font-size: 0.85em;
        }

        .day-number {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 data-i18n="title">Medical Shift Planner</h1>

        <div class="controls">
            <div>
                <button onclick="previousMonth()" data-i18n="previousMonth">Previous Month</button>
                <span id="currentMonth" style="margin: 0 10px; font-weight: bold;"></span>
                <button onclick="nextMonth()" data-i18n="nextMonth">Next Month</button>
            </div>
            <div>
                <button onclick="showStaffModal()" data-i18n="manageStaff">Manage Staff</button>
                <button onclick="showLeaveModal()" data-i18n="manageLeave">Manage Leave</button>
                <button onclick="showAssignmentModal()" data-i18n="assignShifts">Assign Shifts</button>
                <button onclick="showShiftSwapModal()" data-i18n="shiftSwap" style="background-color: #9C27B0;">üîÑ Shift Swap</button>
                <button onclick="showAvailabilityModal()" data-i18n="staffAvailability" style="background-color: #00BCD4;">üìä Availability</button>
                <button onclick="showStatsModal()" data-i18n="workStats" style="background-color: #673AB7;">üìà Stats</button>
                <button onclick="showFilterModal()" data-i18n="filterView">Filter View</button>
                <button onclick="printCalendar()" data-i18n="printCalendar" style="background-color: #FF9800;">üñ®Ô∏è Print</button>
                <button onclick="exportData()" data-i18n="exportData">Export Data</button>
                <button onclick="document.getElementById('importFile').click();" data-i18n="importData">Import Data</button>
                <button onclick="toggleLanguage()" id="langToggle" style="background-color: #2196F3;">EN/PL</button>
            </div>
        </div>

    <!-- Hidden file input for import -->
    <input type="file" id="importFile" accept="application/json" style="display:none" onchange="handleImportFile(event)">

        <!-- Print Legend (only visible when printing) -->
        <div class="print-legend">
            <h3 data-i18n="legend">Legend:</h3>
            <span class="print-legend-item" style="background-color: #cfe2f3;" data-i18n="dayShift">Day Shift</span>
            <span class="print-legend-item" style="background-color: #fff2cc;" data-i18n="nightShift">Night Shift</span>
            <span class="print-legend-item" style="background-color: #d9d2e9;" data-i18n="controlRoom">Control Room</span>
            <span class="print-legend-item" style="background-color: #f4cccc;" data-i18n="ambulance">Ambulance</span>
            <span class="print-legend-item" style="background-color: #d9ead3;" data-i18n="medicalTransport">Medical Transport</span>
        </div>

        <div id="calendar" class="calendar">
            <!-- Calendar will be populated by JavaScript -->
        </div>

        <!-- Staff Management Modal -->
        <div id="staffModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeStaffModal()">&times;</span>
                <h2 data-i18n="manageStaff">Manage Staff</h2>
                <div>
                    <h3 data-i18n="addNewStaff">Add New Staff Member</h3>
                    <div style="margin-bottom: 10px;">
                        <input type="text" id="newPersonName" data-i18n="name" placeholder="Name" style="width: 500px;">
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label><strong data-i18n="employmentType">Employment Type (Required):</strong></label><br>
                        <select id="employmentType" style="width: 500px;" required>
                            <option value="" data-i18n="selectEmploymentType">Select Employment Type</option>
                            <option value="permanent" data-i18n="permanent">Permanent</option>
                            <option value="contractor" data-i18n="contractor">Contractor</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label><strong data-i18n="roles">Roles (Select applicable roles):</strong></label><br>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px;">
                            <label><input type="checkbox" name="roles" value="Doctor"> <span data-i18n="doctor">Doctor</span></label>
                            <label><input type="checkbox" name="roles" value="Driver"> <span data-i18n="driver">Driver</span></label>
                            <label><input type="checkbox" name="roles" value="MedicSenior"> <span data-i18n="medicSenior">Medic Senior</span></label>
                            <label><input type="checkbox" name="roles" value="MedicTrainee"> <span data-i18n="medicTrainee">Medic Trainee</span></label>
                            <label><input type="checkbox" name="roles" value="Transport"> <span data-i18n="transport">Transport</span></label>
                            <label><input type="checkbox" name="roles" value="Nightshift"> <span data-i18n="nightshift">Nightshift</span></label>
                            <label><input type="checkbox" name="roles" value="Dayshift"> <span data-i18n="dayshift">Dayshift</span></label>
                            <label><input type="checkbox" name="roles" value="ControlRoom"> <span data-i18n="controlRoom">Control Room</span></label>
                        </div>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label data-i18n="maxShiftsPerWeek">Maximum shifts per week:</label>
                        <input type="number" id="maxShiftsPerWeek" value="4" min="1" max="7" style="width: 60px;">
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label data-i18n="minRestDays">Minimum rest days between shifts:</label>
                        <input type="number" id="minRestDays" value="1" min="0" max="3" style="width: 60px;">
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label><input type="checkbox" id="weekdaysOnly"> <span data-i18n="weekdaysOnly">Weekdays only (no weekend shifts)</span></label>
                    </div>
                    <button onclick="addPerson()" data-i18n="addStaffMember">Add Staff Member</button>
                </div>
                <div class="staff-list">
                    <h3>Current Staff</h3>
                    <input type="text" id="staffSearch" class="staff-search" placeholder="Search staff by name or role..." oninput="filterStaffList()" />
                    <div class="staff-table-container">
                        <table id="staffTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Employment</th>
                                    <th>Roles</th>
                                    <th>Preferences</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="staffTableBody">
                                <!-- Staff list will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Daily Edit Modal -->
        <div id="dayEditModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeDayEditModal()">&times;</span>
                <h2 id="dayEditModalTitle">Edit Shifts</h2>
                <div id="dayEditForm">
                    <div style="margin-bottom: 20px;">
                        <h3>Day Shift</h3>
                        <select id="dayShiftStaff" style="width: 100%;">
                            <option value="">Select Staff Member</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <h3>Night Shift</h3>
                        <select id="nightShiftStaff" style="width: 100%;">
                            <option value="">Select Staff Member</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <h3>Control Room</h3>
                        <select id="controlRoomStaff" style="width: 100%;">
                            <option value="">Select Staff Member</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <h3>Transports</h3>
                        <div id="transportAssignments" style="max-height: 300px; overflow-y: auto;"></div>
                        <div class="transport-buttons">
                            <button onclick="addTransportCrew('Ambulance')" data-i18n="addAmbulanceCrew">Add Ambulance Crew</button>
                            <button onclick="addTransportCrew('Medical Transport')" data-i18n="addMedicalTransport">Add Medical Transport</button>
                        </div>
                    </div>
                    <button onclick="saveDayEdits()" data-i18n="saveChanges">Save Changes</button>
                </div>
            </div>
        </div>

        <!-- Staff Filter Modal -->
        <div id="filterModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeFilterModal()">&times;</span>
                <h2>Filter Shifts</h2>
                <div>
                    <div style="margin-bottom: 15px;">
                        <label><strong>Staff Member:</strong></label>
                        <select id="filterStaff" style="width: 100%;">
                            <option value="">All Staff Members</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label><strong>Shift Type:</strong></label>
                        <select id="filterShiftType" style="width: 100%;">
                            <option value="">All Shifts</option>
                            <option value="Day">Day Shifts</option>
                            <option value="Night">Night Shifts</option>
                            <option value="ControlRoom">Control Room</option>
                            <option value="Transport">Transports</option>
                        </select>
                    </div>
                    <button onclick="applyFilter()">Apply Filter</button>
                    <button onclick="clearFilter()" style="margin-left: 10px;">Clear Filter</button>
                </div>
            </div>
        </div>

        <!-- Leave Management Modal -->
        <div id="leaveModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeLeaveModal()">&times;</span>
                <h2>Manage Leave</h2>
                <div>
                    <h3>Add Leave Period</h3>
                    <div style="margin-bottom: 10px;">
                        <label><strong>Staff Member:</strong></label><br>
                        <select id="leaveStaffSelect" style="width: 100%;">
                            <!-- Will be populated with staff members -->
                        </select>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label><strong>Leave Type:</strong></label><br>
                        <select id="leaveType" style="width: 100%;">
                            <option value="vacation">Vacation</option>
                            <option value="sickleave">Sick Leave</option>
                            <option value="training">Training</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label><strong>Start Date:</strong></label><br>
                        <input type="date" id="leaveStartDate" style="width: 100%;">
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label><strong>End Date:</strong></label><br>
                        <input type="date" id="leaveEndDate" style="width: 100%;">
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label><strong>Notes:</strong></label><br>
                        <textarea id="leaveNotes" style="width: 100%; height: 60px;"></textarea>
                    </div>
                    <button onclick="addLeave()">Add Leave</button>
                </div>
                <div style="margin-top: 20px;">
                    <h3>Current & Upcoming Leave</h3>
                    <div id="leaveList" style="margin-top: 10px;">
                        <!-- Will be populated with leave entries -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Shift Assignment Modal -->
        <div id="assignmentModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeAssignmentModal()">&times;</span>
                <h2>Assign Shifts</h2>
                <div style="margin-bottom:10px;">
                    <button onclick="assignShiftsForCurrentMonth()">Auto-Assign Shifts for Current Month</button>
                </div>

                <div style="margin-top:10px;">
                    <h3 title="Set the number of vehicles available each day. The assignment algorithm will try to allocate transport staff up to these limits." data-i18n="transportsAvailable">Transports available (per day) <span title="Number of vehicles available per day ‚Äî affects how many transport staff will be assigned.">?</span></h3>
                    <label data-i18n="ambulances">Ambulances:</label>
                    <input type="number" id="ambulanceCount" value="1" min="0" style="width:80px; margin-right:10px;">
                    <label data-i18n="medicalTransports">Medical transports:</label>
                    <input type="number" id="medicalTransportCount" value="1" min="0" style="width:80px; margin-left:10px;">
                    <button onclick="saveTransportsToStorage()" style="margin-left:10px;" data-i18n="saveTransports">Save transports</button>
                </div>

                <div id="assignmentResults" style="margin-top: 16px; font-size:0.95em; color:#333;">
                    <!-- Assignment results and configured transports will be shown here -->
                </div>
            </div>
        </div>

        <!-- Edit Staff Modal -->
        <div id="editStaffModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeEditPersonModal()">&times;</span>
                <h2>Edit Staff Member</h2>
                <div>
                    <div style="margin-bottom: 10px;">
                        <input type="text" id="editPersonName" placeholder="Name" style="width: 200px;">
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label><strong>Employment Type (Required):</strong></label><br>
                        <select id="editEmploymentType" style="width: 200px;" required>
                            <option value="">Select Employment Type</option>
                            <option value="permanent">Permanent</option>
                            <option value="contractor">Contractor</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label><strong>Roles (Select applicable roles):</strong></label><br>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px;">
                            <label><input type="checkbox" name="editRoles" value="Doctor"> Doctor</label>
                            <label><input type="checkbox" name="editRoles" value="Driver"> Driver</label>
                            <label><input type="checkbox" name="editRoles" value="MedicSenior"> Medic Senior</label>
                            <label><input type="checkbox" name="editRoles" value="MedicTrainee"> Medic Trainee</label>
                            <label><input type="checkbox" name="editRoles" value="Transport"> Transport</label>
                            <label><input type="checkbox" name="editRoles" value="Nightshift"> Nightshift</label>
                            <label><input type="checkbox" name="editRoles" value="Dayshift"> Dayshift</label>
                            <label><input type="checkbox" name="editRoles" value="ControlRoom"> Control Room</label>
                        </div>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label>Maximum shifts per week:</label>
                        <input type="number" id="editMaxShiftsPerWeek" value="4" min="1" max="7" style="width: 60px;">
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label>Minimum rest days between shifts:</label>
                        <input type="number" id="editMinRestDays" value="1" min="0" max="3" style="width: 60px;">
                    </div>
                    <input type="hidden" id="editPersonIndex">
                    <button onclick="updatePerson()">Update Staff Member</button>
                </div>
            </div>
        </div>

        <!-- Shift Swap Modal -->
        <div id="shiftSwapModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeShiftSwapModal()">&times;</span>
                <h2 data-i18n="shiftSwap">Shift Swap</h2>
                
                <!-- Create New Swap Request -->
                <div style="margin-bottom: 30px; padding: 15px; background-color: #f5f5f5; border-radius: 4px;">
                    <h3 data-i18n="createSwapRequest">Create Swap Request</h3>
                    
                    <!-- Date Range Filter -->
                    <div style="margin-bottom: 15px; padding: 10px; background-color: #fff; border-radius: 4px; border: 1px solid #ddd;">
                        <label><strong data-i18n="dateRangeFilter">Date Range Filter:</strong></label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 5px;">
                            <div>
                                <label data-i18n="fromDate" style="font-size: 0.9em;">From:</label>
                                <input type="date" id="swapDateFrom" style="width: 100%;" onchange="updateShiftDropdowns()">
                            </div>
                            <div>
                                <label data-i18n="toDate" style="font-size: 0.9em;">To:</label>
                                <input type="date" id="swapDateTo" style="width: 100%;" onchange="updateShiftDropdowns()">
                            </div>
                        </div>
                        <button onclick="clearDateRange()" style="margin-top: 5px; padding: 4px 8px; font-size: 0.85em; background-color: #999;" data-i18n="clearDateRange">Clear Date Range</button>
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <label><strong data-i18n="requestingStaff">Requesting Staff:</strong></label><br>
                        <select id="swapFromStaff" style="width: 100%;" onchange="loadStaffShifts('from')">
                            <option value="" data-i18n="selectStaffMember">Select Staff Member</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label><strong data-i18n="theirShift">Their Shift to Swap:</strong></label><br>
                        <select id="swapFromShift" style="width: 100%;">
                            <option value="" data-i18n="selectShift">Select a shift</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label><strong data-i18n="swapWith">Swap With:</strong></label><br>
                        <select id="swapToStaff" style="width: 100%;" onchange="loadStaffShifts('to')">
                            <option value="" data-i18n="selectStaffMember">Select Staff Member</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label><strong data-i18n="takeTheirShift">Take Their Shift:</strong></label><br>
                        <select id="swapToShift" style="width: 100%;">
                            <option value="" data-i18n="selectShift">Select a shift</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label><strong data-i18n="reason">Reason (optional):</strong></label><br>
                        <textarea id="swapReason" style="width: 100%; height: 60px;" data-i18n="reasonPlaceholder" placeholder="Enter reason for swap request..."></textarea>
                    </div>
                    <button onclick="createSwapRequest()" data-i18n="submitSwapRequest">Submit Swap Request</button>
                </div>

                <!-- View Swap Requests -->
                <div>
                    <h3 data-i18n="swapRequests">Swap Requests</h3>
                    <div style="margin-bottom: 10px;">
                        <label><strong data-i18n="filterBy">Filter by:</strong></label>
                        <select id="swapFilter" style="width: 200px; margin-left: 10px;" onchange="displaySwapRequests()">
                            <option value="all" data-i18n="allRequests">All Requests</option>
                            <option value="pending" data-i18n="pendingRequests">Pending</option>
                            <option value="approved" data-i18n="approvedRequests">Approved</option>
                            <option value="rejected" data-i18n="rejectedRequests">Rejected</option>
                        </select>
                    </div>
                    <div id="swapRequestsList" class="swap-history-container">
                        <!-- Swap requests will be displayed here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Staff Availability Modal -->
        <div id="availabilityModal" class="modal">
            <div class="modal-content" style="max-width: 95%; width: 1400px;">
                <span class="close" onclick="closeAvailabilityModal()">&times;</span>
                <h2 data-i18n="staffAvailability">Staff Availability Calendar</h2>
                
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div>
                            <button onclick="previousMonthAvailability()" data-i18n="previousMonth">Previous Month</button>
                            <span id="availabilityMonth" style="margin: 0 15px; font-weight: bold; font-size: 1.1em;"></span>
                            <button onclick="nextMonthAvailability()" data-i18n="nextMonth">Next Month</button>
                        </div>
                        <div>
                            <label><strong data-i18n="showOnlyAvailable">Show only:</strong></label>
                            <select id="availabilityFilter" style="margin-left: 10px; padding: 5px;" onchange="renderAvailabilityCalendar()">
                                <option value="all" data-i18n="allStaff">All Staff</option>
                                <option value="available" data-i18n="availableOnly">Available Only</option>
                                <option value="unavailable" data-i18n="unavailableOnly">Unavailable Only</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Legend -->
                    <div style="padding: 10px; background-color: #f5f5f5; border-radius: 4px; margin-bottom: 15px;">
                        <strong data-i18n="legend">Legend:</strong>
                        <span style="margin-left: 15px;">
                            <span style="display: inline-block; width: 15px; height: 15px; background-color: #4CAF50; border: 1px solid #333; margin-right: 5px;"></span>
                            <span data-i18n="available">Available</span>
                        </span>
                        <span style="margin-left: 15px;">
                            <span style="display: inline-block; width: 15px; height: 15px; background-color: #FFC107; border: 1px solid #333; margin-right: 5px;"></span>
                            <span data-i18n="scheduled">Scheduled</span>
                        </span>
                        <span style="margin-left: 15px;">
                            <span style="display: inline-block; width: 15px; height: 15px; background-color: #F44336; border: 1px solid #333; margin-right: 5px;"></span>
                            <span data-i18n="onLeave">On Leave</span>
                        </span>
                    </div>
                </div>

                <!-- Availability Grid -->
                <div id="availabilityGrid" style="overflow-x: auto; max-height: 600px; overflow-y: auto;">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Work Statistics Modal -->
        <div id="statsModal" class="modal">
            <div class="modal-content" style="max-width: 1200px;">
                <span class="close" onclick="closeStatsModal()">&times;</span>
                <h2 data-i18n="workStats">Work Statistics</h2>
                
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div>
                            <button onclick="previousMonthStats()" data-i18n="previousMonth">Previous Month</button>
                            <span id="statsMonth" style="margin: 0 15px; font-weight: bold; font-size: 1.1em;"></span>
                            <button onclick="nextMonthStats()" data-i18n="nextMonth">Next Month</button>
                        </div>
                        <div>
                            <button onclick="exportStatsToCSV()" style="background-color: #4CAF50;" data-i18n="exportToCSV">üì• Export to CSV</button>
                        </div>
                    </div>
                    
                    <!-- Summary Cards -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="padding: 15px; background-color: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196F3;">
                            <div style="font-size: 0.9em; color: #666;" data-i18n="totalShifts">Total Shifts</div>
                            <div style="font-size: 2em; font-weight: bold;" id="totalShiftsCount">0</div>
                        </div>
                        <div style="padding: 15px; background-color: #f3e5f5; border-radius: 8px; border-left: 4px solid #9C27B0;">
                            <div style="font-size: 0.9em; color: #666;" data-i18n="totalHours">Total Hours</div>
                            <div style="font-size: 2em; font-weight: bold;" id="totalHoursCount">0</div>
                        </div>
                        <div style="padding: 15px; background-color: #e8f5e9; border-radius: 8px; border-left: 4px solid #4CAF50;">
                            <div style="font-size: 0.9em; color: #666;" data-i18n="avgShiftsPerStaff">Avg Shifts/Staff</div>
                            <div style="font-size: 2em; font-weight: bold;" id="avgShiftsCount">0</div>
                        </div>
                        <div style="padding: 15px; background-color: #fff3e0; border-radius: 8px; border-left: 4px solid #FF9800;">
                            <div style="font-size: 0.9em; color: #666;" data-i18n="avgHoursPerStaff">Avg Hours/Staff</div>
                            <div style="font-size: 2em; font-weight: bold;" id="avgHoursCount">0</div>
                        </div>
                    </div>

                    <!-- Search/Filter -->
                    <div style="margin-bottom: 15px;">
                        <input type="text" id="statsSearch" placeholder="Search staff..." 
                            style="width: 300px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                            oninput="filterStatsTable()" data-i18n-placeholder="searchStaff">
                        <select id="statsSortBy" style="margin-left: 10px; padding: 8px;" onchange="renderStatsTable()">
                            <option value="name" data-i18n="sortByName">Sort by Name</option>
                            <option value="days-desc" data-i18n="sortByDaysDesc">Sort by Days (High-Low)</option>
                            <option value="days-asc" data-i18n="sortByDaysAsc">Sort by Days (Low-High)</option>
                            <option value="hours-desc" data-i18n="sortByHoursDesc">Sort by Hours (High-Low)</option>
                            <option value="hours-asc" data-i18n="sortByHoursAsc">Sort by Hours (Low-High)</option>
                        </select>
                    </div>
                </div>

                <!-- Statistics Table -->
                <div style="overflow-x: auto; max-height: 500px; overflow-y: auto;">
                    <table id="statsTable" style="width: 100%; border-collapse: collapse;">
                        <thead style="position: sticky; top: 0; background-color: #f2f2f2; z-index: 10;">
                            <tr>
                                <th style="padding: 10px; text-align: left; border: 1px solid #ddd;" data-i18n="staff">Staff</th>
                                <th style="padding: 10px; text-align: center; border: 1px solid #ddd;" data-i18n="dayShifts">Day Shifts</th>
                                <th style="padding: 10px; text-align: center; border: 1px solid #ddd;" data-i18n="nightShifts">Night Shifts</th>
                                <th style="padding: 10px; text-align: center; border: 1px solid #ddd;" data-i18n="controlRoom">Control Room</th>
                                <th style="padding: 10px; text-align: center; border: 1px solid #ddd;" data-i18n="transports">Transports</th>
                                <th style="padding: 10px; text-align: center; border: 1px solid #ddd; background-color: #e3f2fd;" data-i18n="totalDays">Total Days</th>
                                <th style="padding: 10px; text-align: center; border: 1px solid #ddd; background-color: #f3e5f5;" data-i18n="totalHours">Total Hours</th>
                            </tr>
                        </thead>
                        <tbody id="statsTableBody">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Language and translations
        let currentLanguage = localStorage.getItem('language') || 'en';
        
        const translations = {
            en: {
                title: 'Medical Shift Planner',
                previousMonth: 'Previous Month',
                nextMonth: 'Next Month',
                manageStaff: 'Manage Staff',
                manageLeave: 'Manage Leave',
                assignShifts: 'Assign Shifts',
                filterView: 'Filter View',
                exportData: 'Export Data',
                importData: 'Import Data',
                runTests: 'Run Tests',
                addNewStaff: 'Add New Staff Member',
                name: 'Name',
                employmentType: 'Employment Type (Required)',
                selectEmploymentType: 'Select Employment Type',
                permanent: 'Permanent',
                contractor: 'Contractor',
                roles: 'Roles (Select applicable roles)',
                doctor: 'Doctor',
                medic: 'Medic',
                driver: 'Driver',
                medicSenior: 'Medic Senior',
                medicTrainee: 'Medic Trainee',
                transport: 'Transport',
                nightshift: 'Nightshift',
                dayshift: 'Dayshift',
                controlRoom: 'Control Room',
                maxShiftsPerWeek: 'Maximum shifts per week',
                minRestDays: 'Minimum rest days between shifts',
                weekdaysOnly: 'Weekdays only (no weekend shifts)',
                addStaffMember: 'Add Staff Member',
                currentStaff: 'Current Staff',
                searchStaff: 'Search staff by name or role...',
                employment: 'Employment',
                preferences: 'Preferences',
                actions: 'Actions',
                edit: 'Edit',
                remove: 'Remove',
                editShifts: 'Edit Shifts',
                editShiftsFor: 'Edit Shifts for',
                dayShift: 'Day Shift',
                nightShift: 'Night Shift',
                transports: 'Transports',
                addAmbulanceCrew: 'Add Ambulance Crew',
                addMedicalTransport: 'Add Medical Transport',
                saveChanges: 'Save Changes',
                filterShifts: 'Filter Shifts',
                staffMember: 'Staff Member',
                allStaffMembers: 'All Staff Members',
                shiftType: 'Shift Type',
                allShifts: 'All Shifts',
                dayShifts: 'Day Shifts',
                nightShifts: 'Night Shifts',
                applyFilter: 'Apply Filter',
                clearFilter: 'Clear Filter',
                addLeavePeriod: 'Add Leave Period',
                leaveType: 'Leave Type',
                vacation: 'Vacation',
                sickleave: 'Sick Leave',
                training: 'Training',
                other: 'Other',
                startDate: 'Start Date',
                endDate: 'End Date',
                notes: 'Notes',
                addLeave: 'Add Leave',
                currentUpcomingLeave: 'Current & Upcoming Leave',
                delete: 'Delete',
                autoAssignShifts: 'Auto-Assign Shifts for Current Month',
                transportsAvailable: 'Transports available (per day)',
                ambulances: 'Ambulances',
                medicalTransports: 'Medical transports',
                saveTransports: 'Save transports',
                editStaffMember: 'Edit Staff Member',
                updateStaffMember: 'Update Staff Member',
                selectStaffMember: 'Select Staff Member',
                selectDoctor: 'Select Doctor',
                selectMedic: 'Select Medic',
                selectDriver: 'Select Driver',
                ambulance: 'Ambulance',
                medicalTransport: 'Medical Transport',
                printCalendar: 'Print Calendar',
                legend: 'Legend',
                days: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
                shiftSwap: 'Shift Swap',
                createSwapRequest: 'Create Swap Request',
                requestingStaff: 'Requesting Staff',
                theirShift: 'Their Shift to Swap',
                swapWith: 'Swap With',
                takeTheirShift: 'Take Their Shift',
                reason: 'Reason (optional)',
                reasonPlaceholder: 'Enter reason for swap request...',
                submitSwapRequest: 'Submit Swap Request',
                swapRequests: 'Swap Requests',
                filterBy: 'Filter by',
                allRequests: 'All Requests',
                pendingRequests: 'Pending',
                approvedRequests: 'Approved',
                rejectedRequests: 'Rejected',
                selectShift: 'Select a shift',
                approve: 'Approve',
                reject: 'Reject',
                cancel: 'Cancel',
                pending: 'Pending',
                approved: 'Approved',
                rejected: 'Rejected',
                swapDetails: 'Swap Details',
                from: 'From',
                to: 'To',
                wants: 'wants',
                inExchangeFor: 'in exchange for',
                dateRangeFilter: 'Date Range Filter',
                fromDate: 'From',
                toDate: 'To',
                clearDateRange: 'Clear Date Range',
                staffAvailability: 'Staff Availability',
                showOnlyAvailable: 'Show only',
                allStaff: 'All Staff',
                availableOnly: 'Available Only',
                unavailableOnly: 'Unavailable Only',
                available: 'Available',
                scheduled: 'Scheduled',
                onLeave: 'On Leave',
                staff: 'Staff',
                workStats: 'Work Statistics',
                totalShifts: 'Total Shifts',
                totalHours: 'Total Hours',
                avgShiftsPerStaff: 'Avg Shifts/Staff',
                avgHoursPerStaff: 'Avg Hours/Staff',
                exportToCSV: 'Export to CSV',
                sortByName: 'Sort by Name',
                sortByDaysDesc: 'Sort by Days (High-Low)',
                sortByDaysAsc: 'Sort by Days (Low-High)',
                sortByHoursDesc: 'Sort by Hours (High-Low)',
                sortByHoursAsc: 'Sort by Hours (Low-High)',
                totalDays: 'Total Days',
                hours: 'hours'
            },
            pl: {
                title: 'Planer Zmian Medycznych',
                previousMonth: 'Poprzedni MiesiƒÖc',
                nextMonth: 'Nastƒôpny MiesiƒÖc',
                manageStaff: 'ZarzƒÖdzaj Personelem',
                manageLeave: 'ZarzƒÖdzaj Urlopami',
                assignShifts: 'Przypisz Zmiany',
                filterView: 'Filtruj Widok',
                exportData: 'Eksportuj Dane',
                importData: 'Importuj Dane',
                runTests: 'Uruchom Testy',
                addNewStaff: 'Dodaj Nowego Pracownika',
                name: 'Imiƒô i nazwisko',
                employmentType: 'Typ Zatrudnienia (Wymagane)',
                selectEmploymentType: 'Wybierz Typ Zatrudnienia',
                permanent: 'Sta≈Çy',
                contractor: 'Kontrakt',
                roles: 'Role (Wybierz odpowiednie role)',
                doctor: 'Lekarz',
                medic: 'Ratownik',
                driver: 'Kierowca',
                medicSenior: 'Ratownik Starszy',
                medicTrainee: 'Ratownik Sta≈ºysta',
                transport: 'Transport',
                nightshift: 'Zmiana Nocna',
                dayshift: 'Zmiana Dzienna',
                controlRoom: 'Dyspozytornia',
                maxShiftsPerWeek: 'Maksymalna liczba zmian w tygodniu',
                minRestDays: 'Minimalne dni odpoczynku miƒôdzy zmianami',
                weekdaysOnly: 'Tylko dni powszednie (bez weekend√≥w)',
                addStaffMember: 'Dodaj Pracownika',
                currentStaff: 'Obecny Personel',
                searchStaff: 'Szukaj po imieniu lub roli...',
                employment: 'Zatrudnienie',
                preferences: 'Preferencje',
                actions: 'Akcje',
                edit: 'Edytuj',
                remove: 'Usu≈Ñ',
                editShifts: 'Edytuj Zmiany',
                editShiftsFor: 'Edytuj Zmiany dla',
                dayShift: 'Zmiana Dzienna',
                nightShift: 'Zmiana Nocna',
                transports: 'Transporty',
                addAmbulanceCrew: 'Dodaj Zesp√≥≈Ç Ambulansu',
                addMedicalTransport: 'Dodaj Transport Medyczny',
                saveChanges: 'Zapisz Zmiany',
                filterShifts: 'Filtruj Zmiany',
                staffMember: 'Pracownik',
                allStaffMembers: 'Wszyscy Pracownicy',
                shiftType: 'Typ Zmiany',
                allShifts: 'Wszystkie Zmiany',
                dayShifts: 'Zmiany Dzienne',
                nightShifts: 'Zmiany Nocne',
                applyFilter: 'Zastosuj Filtr',
                clearFilter: 'Wyczy≈õƒá Filtr',
                addLeavePeriod: 'Dodaj Okres Urlopu',
                leaveType: 'Typ Urlopu',
                vacation: 'Urlop',
                sickleave: 'Zwolnienie Lekarskie',
                training: 'Szkolenie',
                other: 'Inne',
                startDate: 'Data Rozpoczƒôcia',
                endDate: 'Data Zako≈Ñczenia',
                notes: 'Notatki',
                addLeave: 'Dodaj Urlop',
                currentUpcomingLeave: 'Obecne i NadchodzƒÖce Urlopy',
                delete: 'Usu≈Ñ',
                autoAssignShifts: 'Automatycznie Przypisz Zmiany na Bie≈ºƒÖcy MiesiƒÖc',
                transportsAvailable: 'Dostƒôpne transporty (dziennie)',
                ambulances: 'Ambulanse',
                medicalTransports: 'Transporty medyczne',
                saveTransports: 'Zapisz transporty',
                editStaffMember: 'Edytuj Pracownika',
                updateStaffMember: 'Zaktualizuj Pracownika',
                selectStaffMember: 'Wybierz Pracownika',
                selectDoctor: 'Wybierz Lekarza',
                selectMedic: 'Wybierz Ratownika',
                selectDriver: 'Wybierz Kierowcƒô',
                ambulance: 'Ambulans',
                medicalTransport: 'Transport Medyczny',
                printCalendar: 'Drukuj Kalendarz',
                legend: 'Legenda',
                days: ['Nd', 'Pn', 'Wt', '≈ör', 'Cz', 'Pt', 'Sb'],
                shiftSwap: 'Zamiana Zmian',
                createSwapRequest: 'Utw√≥rz Pro≈õbƒô o Zamianƒô',
                requestingStaff: 'Pracownik ProszƒÖcy',
                theirShift: 'Ich Zmiana do Zamiany',
                swapWith: 'Zamie≈Ñ z',
                takeTheirShift: 'Przejmij Ich Zmianƒô',
                reason: 'Pow√≥d (opcjonalnie)',
                reasonPlaceholder: 'Wprowad≈∫ pow√≥d pro≈õby o zamianƒô...',
                submitSwapRequest: 'Wy≈õlij Pro≈õbƒô o Zamianƒô',
                swapRequests: 'Pro≈õby o Zamianƒô',
                filterBy: 'Filtruj wed≈Çug',
                allRequests: 'Wszystkie Pro≈õby',
                pendingRequests: 'OczekujƒÖce',
                approvedRequests: 'Zatwierdzone',
                rejectedRequests: 'Odrzucone',
                selectShift: 'Wybierz zmianƒô',
                approve: 'Zatwierd≈∫',
                reject: 'Odrzuƒá',
                cancel: 'Anuluj',
                pending: 'OczekujƒÖce',
                approved: 'Zatwierdzone',
                rejected: 'Odrzucone',
                swapDetails: 'Szczeg√≥≈Çy Zamiany',
                from: 'Od',
                to: 'Do',
                wants: 'chce',
                inExchangeFor: 'w zamian za',
                dateRangeFilter: 'Filtr Zakresu Dat',
                fromDate: 'Od',
                toDate: 'Do',
                clearDateRange: 'Wyczy≈õƒá Zakres Dat',
                staffAvailability: 'Dostƒôpno≈õƒá Personelu',
                showOnlyAvailable: 'Poka≈º tylko',
                allStaff: 'Ca≈Çy Personel',
                availableOnly: 'Tylko Dostƒôpni',
                unavailableOnly: 'Tylko Niedostƒôpni',
                available: 'Dostƒôpny',
                scheduled: 'Zaplanowany',
                onLeave: 'Na Urlopie',
                staff: 'Personel',
                workStats: 'Statystyki Pracy',
                totalShifts: 'Ca≈Çkowite Zmiany',
                totalHours: 'Ca≈Çkowite Godziny',
                avgShiftsPerStaff: '≈örednio Zmian/Pracownik',
                avgHoursPerStaff: '≈örednio Godzin/Pracownik',
                exportToCSV: 'Eksportuj do CSV',
                sortByName: 'Sortuj wed≈Çug Imienia',
                sortByDaysDesc: 'Sortuj wed≈Çug Dni (Wysoki-Niski)',
                sortByDaysAsc: 'Sortuj wed≈Çug Dni (Niski-Wysoki)',
                sortByHoursDesc: 'Sortuj wed≈Çug Godzin (Wysoki-Niski)',
                sortByHoursAsc: 'Sortuj wed≈Çug Godzin (Niski-Wysoki)',
                totalDays: 'Ca≈Çkowite Dni',
                hours: 'godziny'
            }
        };

        function t(key) {
            return translations[currentLanguage][key] || key;
        }

        function toggleLanguage() {
            currentLanguage = currentLanguage === 'en' ? 'pl' : 'en';
            localStorage.setItem('language', currentLanguage);
            updateLanguage();
        }

        function updateLanguage() {
            // Update title
            document.querySelector('h1').textContent = t('title');
            
            // Update all elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (el.tagName === 'INPUT' && el.type === 'text') {
                    el.placeholder = t(key);
                } else if (el.tagName === 'OPTION') {
                    el.textContent = t(key);
                } else if (el.tagName === 'LABEL') {
                    // Handle labels with nested elements
                    const strong = el.querySelector('strong');
                    if (strong) {
                        strong.textContent = t(key);
                    } else {
                        el.textContent = t(key);
                    }
                } else {
                    el.textContent = t(key);
                }
            });
            
            // Update modals and forms that weren't tagged
            updateModalTranslations();
            
            // Update calendar and other dynamic content
            updateCalendar();
        }

        function updateModalTranslations() {
            // Update Staff Modal elements
            const staffSearchInput = document.getElementById('staffSearch');
            if (staffSearchInput) staffSearchInput.placeholder = t('searchStaff');

            // Update Leave Modal  "Select Staff Member" option
            const leaveStaffSelect = document.getElementById('leaveStaffSelect');
            if (leaveStaffSelect && leaveStaffSelect.options[0]) {
                leaveStaffSelect.options[0].textContent = t('selectStaffMember');
            }

            // Update day edit modal dropdowns
            ['dayShiftStaff', 'nightShiftStaff', 'controlRoomStaff'].forEach(id => {
                const dropdown = document.getElementById(id);
                if (dropdown && dropdown.options[0]) {
                    dropdown.options[0].textContent = t('selectStaffMember');
                }
            });

            // Update Filter Modal dropdown
            const filterStaff = document.getElementById('filterStaff');
            if (filterStaff && filterStaff.options[0]) {
                filterStaff.options[0].textContent = t('allStaffMembers');
            }
        }

        // Global variables
        let currentDate = new Date();
        let availabilityDate = new Date();
        let statsDate = new Date();
        let people = [];
        let assignments = {};
        let leaveRecords = [];
        let swapRequests = [];
        let currentFilter = {
            staffMember: '',
            shiftType: ''
        };
        let editingDate = null;

        // Initialize the application
        window.onload = function() {
            loadPeopleFromStorage();
            loadAssignmentsFromStorage();
            loadTransportsFromStorage();
            loadLeaveFromStorage();
            loadSwapRequestsFromStorage();
            updateLanguage();
            updateCalendar();
        };

        function loadLeaveFromStorage() {
            const storedLeave = localStorage.getItem('leaveRecords');
            if (storedLeave) {
                leaveRecords = JSON.parse(storedLeave);
            }
        }

        function saveLeaveToStorage() {
            localStorage.setItem('leaveRecords', JSON.stringify(leaveRecords));
        }

        function showLeaveModal() {
            const modal = document.getElementById('leaveModal');
            const staffSelect = document.getElementById('leaveStaffSelect');
            
            // Clear and populate staff select
            staffSelect.innerHTML = '<option value="">Select Staff Member</option>';
            people.forEach(person => {
                const option = document.createElement('option');
                option.value = person.name;
                option.textContent = person.name;
                staffSelect.appendChild(option);
            });

            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('leaveStartDate').value = today;
            document.getElementById('leaveEndDate').value = today;
            
            // Update leave list
            updateLeaveList();
            
            modal.style.display = 'block';
        }

        function closeLeaveModal() {
            document.getElementById('leaveModal').style.display = 'none';
        }

        function addLeave() {
            const staffName = document.getElementById('leaveStaffSelect').value;
            const leaveType = document.getElementById('leaveType').value;
            const startDate = document.getElementById('leaveStartDate').value;
            const endDate = document.getElementById('leaveEndDate').value;
            const notes = document.getElementById('leaveNotes').value;

            if (!staffName || !leaveType || !startDate || !endDate) {
                alert('Please fill in all required fields');
                return;
            }

            if (new Date(endDate) < new Date(startDate)) {
                alert('End date cannot be before start date');
                return;
            }

            const leaveRecord = {
                staffName,
                leaveType,
                startDate,
                endDate,
                notes,
                dateAdded: new Date().toISOString()
            };

            leaveRecords.push(leaveRecord);
            saveLeaveToStorage();
            updateLeaveList();
            
            // Clear form
            document.getElementById('leaveStaffSelect').value = '';
            document.getElementById('leaveType').value = 'vacation';
            document.getElementById('leaveNotes').value = '';
        }

        function updateLeaveList() {
            const leaveList = document.getElementById('leaveList');
            leaveList.innerHTML = '';

            // Sort leave records by start date
            const sortedRecords = [...leaveRecords].sort((a, b) => 
                new Date(a.startDate) - new Date(b.startDate)
            );

            // Filter to show only current and future leave
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            sortedRecords.forEach((record, index) => {
                const endDate = new Date(record.endDate);
                endDate.setHours(0, 0, 0, 0);
                
                if (endDate >= today) {
                    const div = document.createElement('div');
                    div.className = 'leave-record';
                    div.innerHTML = `
                        <div style="border: 1px solid #ddd; padding: 10px; margin-bottom: 10px;">
                            <strong>${record.staffName}</strong> - ${record.leaveType}<br>
                            ${new Date(record.startDate).toLocaleDateString()} to 
                            ${new Date(record.endDate).toLocaleDateString()}<br>
                            ${record.notes ? `<em>${record.notes}</em><br>` : ''}
                            <button onclick="deleteLeave(${index})">Delete</button>
                        </div>
                    `;
                    leaveList.appendChild(div);
                }
            });

            if (leaveList.children.length === 0) {
                leaveList.innerHTML = '<p>No current or upcoming leave recorded.</p>';
            }
        }

        function deleteLeave(index) {
            if (confirm('Are you sure you want to delete this leave record?')) {
                leaveRecords.splice(index, 1);
                saveLeaveToStorage();
                updateLeaveList();
            }
        }

        // Daily Edit Functions
        function showDayEditModal(date) {
            editingDate = date;
            const modal = document.getElementById('dayEditModal');
            const dateStr = new Date(date).toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('dayEditModalTitle').textContent = `Edit Shifts for ${dateStr}`;

            // Populate staff dropdowns
            const dropdowns = ['dayShiftStaff', 'nightShiftStaff', 'controlRoomStaff'];
            dropdowns.forEach(id => populateStaffDropdown(id, date));

            // Set current values
            const dateKey = formatDateKey(date);
            const dayAssignments = assignments[dateKey] || {};
            
            if (dayAssignments.Day) document.getElementById('dayShiftStaff').value = dayAssignments.Day;
            if (dayAssignments.Night) document.getElementById('nightShiftStaff').value = dayAssignments.Night;
            if (dayAssignments.ControlRoom) document.getElementById('controlRoomStaff').value = dayAssignments.ControlRoom;

            updateTransportCrews(dateKey);
            modal.style.display = 'block';
        }

        function populateStaffDropdown(dropdownId, date) {
            const dropdown = document.getElementById(dropdownId);
            dropdown.innerHTML = '<option value="">Select Staff Member</option>';
            
            const eligibleStaff = getEligibleStaff(people, new Date(date));
            eligibleStaff.forEach(person => {
                const option = document.createElement('option');
                option.value = person.name;
                option.textContent = person.name;
                dropdown.appendChild(option);
            });
        }

        function addTransportCrew(transportType) {
            const dateKey = formatDateKey(editingDate);
            
            // Ensure assignments structure exists
            if (!assignments[dateKey]) {
                assignments[dateKey] = { Transports: [] };
            }
            
            if (!assignments[dateKey].Transports) {
                assignments[dateKey].Transports = [];
            }

            // Get limits from transportsConfig (the actual source of truth)
            const limits = {
                'Ambulance': transportsConfig.ambulance || 0,
                'Medical Transport': transportsConfig.medical || 0
            };

            const currentCounts = {
                'Ambulance': assignments[dateKey].Transports.filter(t => t.type === 'Ambulance').length,
                'Medical Transport': assignments[dateKey].Transports.filter(t => t.type === 'Medical Transport').length
            };

            // Check if we can add more of this type
            if (currentCounts[transportType] >= limits[transportType]) {
                const message = `Cannot add more ${transportType}s. Maximum of ${limits[transportType]} allowed per day.\n\nCurrent: ${currentCounts[transportType]}, Limit: ${limits[transportType]}`;
                alert(message);
                return;
            }

            // Add new transport crew
            const newCrew = {
                type: transportType,
                crew: { Doctor: '', Medic: '', Driver: '' }
            };
            
            assignments[dateKey].Transports.push(newCrew);
            saveAssignmentsToStorage(); // Save changes to localStorage
            updateTransportCrews(dateKey); // Update the display
        }

        function updateTransportCrews(dateKey) {
    const container = document.getElementById('transportAssignments');
    if (!container) return;
    
    container.innerHTML = '';

    if (!assignments[dateKey]) {
        assignments[dateKey] = { Transports: [] };
    }
    
    if (!assignments[dateKey].Transports) {
        assignments[dateKey].Transports = [];
    }

    // Display each transport crew
    assignments[dateKey].Transports.forEach((transport, index) => {
        // Create container for this crew
        const transportDiv = document.createElement('div');
        transportDiv.className = 'transport-crew';
        transportDiv.innerHTML = `
            <h4>${transport.type}</h4>
            <select id="transport-${index}-doctor" class="transport-staff" data-role="Doctor" data-index="${index}">
                <option value="">Select Doctor</option>
            </select>
            <select id="transport-${index}-medic" class="transport-staff" data-role="Medic" data-index="${index}">
                <option value="">Select Medic</option>
            </select>
            <select id="transport-${index}-driver" class="transport-staff" data-role="Driver" data-index="${index}">
                <option value="">Select Driver</option>
            </select>
            <button onclick="removeTransportCrew(${index})" class="remove-button">Remove</button>
        `;
        container.appendChild(transportDiv);

        // Populate dropdowns for this crew
        ['doctor', 'medic', 'driver'].forEach(role => {
            const select = document.getElementById(`transport-${index}-${role}`);
            if (!select) return;

            const staffRole = role.charAt(0).toUpperCase() + role.slice(1);
            const eligibleStaff = getEligibleStaff(people, new Date(editingDate));
            
            select.options.length = 1; // Keep only the default option
            
            eligibleStaff.forEach(person => {
                const option = document.createElement('option');
                option.value = person.name;
                option.textContent = person.name;
                select.appendChild(option);
            });
            
            if (transport.crew && transport.crew[staffRole]) {
                select.value = transport.crew[staffRole];
            }
        });
    });
}
        function removeTransportCrew(index) {
            const dateKey = formatDateKey(editingDate);
            assignments[dateKey].Transports.splice(index, 1);
            updateTransportCrews(dateKey);
        }

        function saveDayEdits() {
            const dateKey = formatDateKey(editingDate);
            if (!assignments[dateKey]) {
                assignments[dateKey] = { Transports: [] };
            }

            assignments[dateKey].Day = document.getElementById('dayShiftStaff').value;
            assignments[dateKey].Night = document.getElementById('nightShiftStaff').value;
            assignments[dateKey].ControlRoom = document.getElementById('controlRoomStaff').value;

            saveAssignmentsToStorage();
            updateCalendar();
            closeDayEditModal();
        }

        function closeDayEditModal() {
            document.getElementById('dayEditModal').style.display = 'none';
            editingDate = null;
        }

        // Filter Functions
        function showFilterModal() {
            const modal = document.getElementById('filterModal');
            const staffSelect = document.getElementById('filterStaff');
            
            // Populate staff select
            staffSelect.innerHTML = '<option value="">All Staff Members</option>';
            people.forEach(person => {
                const option = document.createElement('option');
                option.value = person.name;
                option.textContent = person.name;
                staffSelect.appendChild(option);
            });

            // Set current filter values
            staffSelect.value = currentFilter.staffMember;
            document.getElementById('filterShiftType').value = currentFilter.shiftType;
            
            modal.style.display = 'block';
        }

        function closeFilterModal() {
            document.getElementById('filterModal').style.display = 'none';
        }

        function applyFilter() {
            currentFilter.staffMember = document.getElementById('filterStaff').value;
            currentFilter.shiftType = document.getElementById('filterShiftType').value;
            updateCalendar();
            closeFilterModal();
        }

        function clearFilter() {
            currentFilter.staffMember = '';
            currentFilter.shiftType = '';
            document.getElementById('filterStaff').value = '';
            document.getElementById('filterShiftType').value = '';
            updateCalendar();
            closeFilterModal();
        }

        function formatDateKey(date) {
            const d = new Date(date);
            return `${d.getFullYear()}-${d.getMonth() + 1}-${d.getDate()}`;
        }

        function getEligibleStaff(staff, date, excludePerson = null) {
            const isWeekend = date.getDay() === 0 || date.getDay() === 6;
            return staff.filter(person => {
                // Check if person is excluded
                if (excludePerson && person === excludePerson) return false;
                
                // Check weekdays only preference
                if (person.availability.weekdaysOnly && isWeekend) return false;
                
                // Check if person is on leave
                if (isPersonOnLeave(person.name, date)) return false;
                
                // Check rest period
                if (person.lastShiftDate) {
                    const daysSinceLastShift = Math.floor(
                        (date - new Date(person.lastShiftDate)) / (1000 * 60 * 60 * 24)
                    );
                    if (daysSinceLastShift < person.availability.minRestDays) return false;
                }
                
                return true;
            });
        }

        function isPersonOnLeave(personName, date) {
            const checkDate = new Date(date);
            checkDate.setHours(0, 0, 0, 0);

            return leaveRecords.some(record => {
                const startDate = new Date(record.startDate);
                const endDate = new Date(record.endDate);
                startDate.setHours(0, 0, 0, 0);
                endDate.setHours(0, 0, 0, 0);

                return record.staffName === personName &&
                    checkDate >= startDate &&
                    checkDate <= endDate;
            });
        }

        // Calendar navigation functions
        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            updateCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            updateCalendar();
        }

        function printCalendar() {
            // Show instructions for enabling background colors
            const message = currentLanguage === 'pl' 
                ? 'WA≈ªNE: W oknie druku upewnij siƒô, ≈ºe opcja "Grafika t≈Ça" lub "Background graphics" jest W≈ÅƒÑCZONA, aby zobaczyƒá kolory.\n\n' +
                  'Chrome/Edge: Wiƒôcej ustawie≈Ñ ‚Üí Grafika t≈Ça\n' +
                  'Firefox: WyglƒÖd strony ‚Üí Drukuj t≈Ça'
                : 'IMPORTANT: In the print dialog, make sure "Background graphics" is ENABLED to see colors.\n\n' +
                  'Chrome/Edge: More settings ‚Üí Background graphics\n' +
                  'Firefox: Appearance ‚Üí Print backgrounds';
            
            alert(message);
            
            // Trigger the browser's print dialog
            window.print();
        }

        // Calendar rendering
        function updateCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            // Update month display
            const locale = currentLanguage === 'pl' ? 'pl-PL' : 'en-US';
            document.getElementById('currentMonth').textContent = 
                new Date(year, month).toLocaleDateString(locale, { month: 'long', year: 'numeric' });

            // Clear existing calendar
            const calendar = document.getElementById('calendar');
            calendar.innerHTML = '';

            // Add day headers
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            function formatShiftDisplay(assignments, dateKey) {
                if (!assignments[dateKey]) return '';

                let shiftInfo = [];
                const shifts = assignments[dateKey];

                // Filter by staff member if specified
                const staffFilter = currentFilter.staffMember;
                const shiftFilter = currentFilter.shiftType;

                function addShift(role, name) {
                    if (!name) return;
                    if (staffFilter && staffFilter !== name) return;
                    if (shiftFilter && shiftFilter !== role) return;
                    shiftInfo.push(`${role}: ${name}`);
                }

                addShift('Day', shifts.Day);
                addShift('Night', shifts.Night);
                addShift('ControlRoom', shifts.ControlRoom);

                if (shifts.Transports) {
                    shifts.Transports.forEach(transport => {
                        Object.entries(transport.crew).forEach(([role, name]) => {
                            if (staffFilter && staffFilter !== name) return;
                            if (shiftFilter && shiftFilter !== 'Transport') return;
                            const transportTypeLabel = transport.type === 'Ambulance' ? t('ambulance') : t('medicalTransport');
                            shiftInfo.push(`${transportTypeLabel} ${role}: ${name}`);
                        });
                    });
                }

                return shiftInfo.join('<br>');
            }
            const dayHeaders = translations[currentLanguage].days || days;
            dayHeaders.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-header';
                dayHeader.textContent = day;
                calendar.appendChild(dayHeader);
            });

            // Get the first day of the month and number of days
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Add blank cells for days before the first of the month
            for (let i = 0; i < firstDay; i++) {
                const blankDay = document.createElement('div');
                blankDay.className = 'calendar-day empty';
                calendar.appendChild(blankDay);
            }

            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month, day);
                const dayCell = document.createElement('div');
                const currentDateKey = `${year}-${month + 1}-${day}`;
                
                // Set up classes
                let classes = ['calendar-day'];
                if (currentDate.getDay() === 0 || currentDate.getDay() === 6) classes.push('weekend');
                
                // Check if it's today
                const today = new Date();
                if (year === today.getFullYear() && 
                    month === today.getMonth() && 
                    day === today.getDate()) {
                    classes.push('today');
                }
                dayCell.className = classes.join(' ');

                // Add day number
                const dayLabel = document.createElement('div');
                dayLabel.className = 'day-number';
                dayLabel.textContent = day;
                dayCell.appendChild(dayLabel);

                // Add shift info
                const shiftInfo = document.createElement('div');
                shiftInfo.className = 'shift-info';
                shiftInfo.innerHTML = formatShiftDisplay(assignments, currentDateKey);
                
                // Apply visual indication for filtered results
                if ((currentFilter.staffMember || currentFilter.shiftType) && shiftInfo.innerHTML) {
                    dayCell.classList.add('filtered');
                }
                
                dayCell.appendChild(shiftInfo);

                // Add click handler
                dayCell.onclick = () => showDayEditModal(currentDate);

                // Add assignments if they exist
                const dateKey = `${year}-${month + 1}-${day}`;
                if (assignments[dateKey]) {
                    if (assignments[dateKey].Day) {
                        const dayShift = document.createElement('div');
                        dayShift.className = 'assignment day';
                        dayShift.textContent = `D: ${assignments[dateKey].Day}`;
                        dayCell.appendChild(dayShift);
                    }
                    if (assignments[dateKey].Night) {
                        const nightShift = document.createElement('div');
                        nightShift.className = 'assignment night';
                        nightShift.textContent = `N: ${assignments[dateKey].Night}`;
                        dayCell.appendChild(nightShift);
                    }
                    if (assignments[dateKey].ControlRoom) {
                        const controlShift = document.createElement('div');
                        controlShift.className = 'assignment control';
                        controlShift.textContent = `C: ${assignments[dateKey].ControlRoom}`;
                        dayCell.appendChild(controlShift);
                    }
                    if (assignments[dateKey].Transports && assignments[dateKey].Transports.length) {
                        assignments[dateKey].Transports.forEach(transport => {
                            const transportDiv = document.createElement('div');
                            transportDiv.className = `assignment ${transport.type === 'Ambulance' ? 'ambulance' : 'medical'}`;
                            const crewText = Object.entries(transport.crew)
                                .map(([role, name]) => {
                                    // Translate role names
                                    let translatedRole = role;
                                    if (role === 'Doctor') translatedRole = t('doctor');
                                    else if (role === 'Medic') translatedRole = t('medic');
                                    else if (role === 'Driver') translatedRole = t('driver');
                                    return `${name} (${translatedRole})`;
                                })
                                .join(', ');
                            const transportTypeLabel = transport.type === 'Ambulance' ? t('ambulance') : t('medicalTransport');
                            transportDiv.textContent = `${transportTypeLabel}: ${crewText}`;
                            dayCell.appendChild(transportDiv);
                        });
                    }
                }

                calendar.appendChild(dayCell);
            }
        }

        // Staff management functions
        function loadPeopleFromStorage() {
            const savedPeople = localStorage.getItem('people');
            if (savedPeople) {
                people = JSON.parse(savedPeople);
                
                // Migrate old data format to new format
                people = people.map(person => {
                    if (!person.employmentType || !person.roles) {
                        return {
                            ...person,
                            employmentType: person.employmentType || 'unknown',
                            roles: person.roles || (person.role ? [person.role] : []),
                            availability: person.availability || {
                                maxShiftsPerWeek: 4,
                                minRestDays: 1
                            }
                        };
                    }
                    return person;
                });
                
                // Save migrated data
                savePeopleToStorage();
            }
            updateStaffTable();
        }

        function savePeopleToStorage() {
            localStorage.setItem('people', JSON.stringify(people));
        }

        function loadAssignmentsFromStorage() {
            const savedAssignments = localStorage.getItem('assignments');
            if (savedAssignments) {
                assignments = JSON.parse(savedAssignments);
            }
        }

        function saveAssignmentsToStorage() {
            localStorage.setItem('assignments', JSON.stringify(assignments));
        }

        function addPerson() {
            const name = document.getElementById('newPersonName').value.trim();
            const employmentType = document.getElementById('employmentType').value;
            const roles = Array.from(document.getElementsByName('roles'))
                .filter(checkbox => checkbox.checked)
                .map(checkbox => checkbox.value);

            if (!name || !employmentType) {
                alert('Please provide both name and employment type.');
                return;
            }

            if (roles.length === 0) {
                alert('Please select at least one role.');
                return;
            }

            const maxShiftsPerWeek = parseInt(document.getElementById('maxShiftsPerWeek').value) || 4;
            const minRestDays = parseInt(document.getElementById('minRestDays').value) || 1;
            const weekdaysOnly = document.getElementById('weekdaysOnly').checked;
            
            people.push({ 
                name,
                employmentType,
                roles,
                availability: {
                    maxShiftsPerWeek,
                    minRestDays,
                    weekdaysOnly
                },
                lastShift: null
            });

            savePeopleToStorage();
            updateStaffTable();

            // Reset form
            document.getElementById('newPersonName').value = '';
            document.getElementById('employmentType').value = '';
            document.getElementsByName('roles').forEach(checkbox => checkbox.checked = false);
            document.getElementById('maxShiftsPerWeek').value = '4';
            document.getElementById('minRestDays').value = '1';
        }

        function removePerson(index) {
            people.splice(index, 1);
            savePeopleToStorage();
            updateStaffTable();
        }

        function updateStaffTable() {
            const tbody = document.getElementById('staffTableBody');
            tbody.innerHTML = '';

            people.forEach((person, index) => {
                const row = tbody.insertRow();
                row.insertCell(0).textContent = person.name;
                row.insertCell(1).textContent = person.employmentType ? 
                    (person.employmentType.charAt(0).toUpperCase() + person.employmentType.slice(1)) : 'Unknown';
                row.insertCell(2).textContent = person.roles ? person.roles.join(', ') : 
                    (person.role ? person.role : 'Unknown');
                
                // Add preferences cell
                const preferences = [];
                if (person.availability.weekdaysOnly) preferences.push('Weekdays only');
                if (person.availability.maxShiftsPerWeek) preferences.push(`Max ${person.availability.maxShiftsPerWeek} shifts/week`);
                if (person.availability.minRestDays) preferences.push(`${person.availability.minRestDays} rest day(s)`);
                row.insertCell(3).textContent = preferences.join(', ');
                
                const actionsCell = row.insertCell(3);
                
                // Add Edit button
                const editButton = document.createElement('button');
                editButton.textContent = 'Edit';
                editButton.style.marginRight = '5px';
                editButton.onclick = () => showEditPersonModal(index);
                actionsCell.appendChild(editButton);

                // Add Delete button
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Remove';
                deleteButton.onclick = () => removePerson(index);
                actionsCell.appendChild(deleteButton);

                // Store searchable text for filtering
                row.dataset.search = (
                    (person.name || '') + ' ' + 
                    (person.roles ? person.roles.join(' ') : (person.role || '')) + ' ' +
                    (person.employmentType || '')
                ).toLowerCase();
            });

            // Apply current search filter if any
            filterStaffList();
        }

        function filterStaffList() {
            const query = (document.getElementById('staffSearch') && document.getElementById('staffSearch').value || '').trim().toLowerCase();
            const tbody = document.getElementById('staffTableBody');
            if (!tbody) return;
            Array.from(tbody.rows).forEach(row => {
                if (!query) {
                    row.style.display = '';
                    return;
                }
                const text = row.dataset.search || row.textContent.toLowerCase();
                row.style.display = text.indexOf(query) !== -1 ? '' : 'none';
            });
        }

        // Modal management
        function showStaffModal() {
            document.getElementById('staffModal').style.display = 'block';
        }

        function closeStaffModal() {
            document.getElementById('staffModal').style.display = 'none';
        }

        function showAssignmentModal() {
            document.getElementById('assignmentModal').style.display = 'block';
        }

        function closeAssignmentModal() {
            document.getElementById('assignmentModal').style.display = 'none';
        }

        // Shift assignment functions
        function assignShiftsForCurrentMonth() {
        function assignShiftsForCurrentMonth() {
            function getStartOfWeek(date) {
                const d = new Date(date);
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                return new Date(d.setDate(diff));
            }

            function updatePersonCounts(person, date, isWeekend) {
                person.monthlyShifts = person.monthlyShifts || { total: 0, weekends: 0 };
                person.monthlyShifts.total++;
                if (isWeekend) person.monthlyShifts.weekends++;
                person.weeklyShifts = (person.weeklyShifts || 0) + 1;
                person.lastShiftDate = date.toISOString();
            }

            function filterAndSortPeople(people, date) {
                return people.filter(person => {
                    // Check weekly shift limit
                    if (person.weeklyShifts >= person.availability.maxShiftsPerWeek) return false;
                    return true;
                }).sort((a, b) => {
                    if (date.getDay() === 0 || date.getDay() === 6) {
                        if (a.monthlyShifts.weekends !== b.monthlyShifts.weekends) {
                            return a.monthlyShifts.weekends - b.monthlyShifts.weekends;
                        }
                    }
                    return a.monthlyShifts.total - b.monthlyShifts.total;
                });
            }

            try {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                // Get staff with clinical roles
                const clinicalStaff = people.filter(person => 
                    person.roles.some(role => ['Doctor', 'MedicSenior', 'MedicTrainee'].includes(role))
                );

                if (clinicalStaff.length < 2) {
                    throw new Error('Not enough clinical staff members to assign shifts!');
                }

                // Initialize assignments and reset staff counts
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateKey = `${year}-${month + 1}-${day}`;
                    if (!assignments[dateKey]) {
                        assignments[dateKey] = Object.create(null);
                    }
                    assignments[dateKey].Day = null;
                    assignments[dateKey].Night = null;
                    assignments[dateKey].ControlRoom = null;
                    assignments[dateKey].Transports = [];
                }

                // Reset monthly and weekly counts
                clinicalStaff.forEach(person => {
                    person.monthlyShifts = { total: 0, weekends: 0 };
                    person.weeklyShifts = 0;
                    person.lastShiftDate = null;
                });

                // Assign shifts for each day
                for (let day = 1; day <= daysInMonth; day++) {
                    const shiftDate = new Date(year, month, day);
                    const dateKey = `${year}-${month + 1}-${day}`;
                    const isWeekend = shiftDate.getDay() === 0 || shiftDate.getDay() === 6;

                    // Get and assign day shift person
                    let eligibleDay = getEligibleStaff(clinicalStaff, shiftDate);
                    if (!eligibleDay.length) {
                        clinicalStaff.forEach(p => p.weeklyShifts = 0);
                        eligibleDay = clinicalStaff;
                    }
                    const dayPerson = eligibleDay[0];
                    assignments[dateKey].Day = dayPerson.name;

                    // Get and assign night shift person
                    let eligibleNight = getEligibleStaff(clinicalStaff, shiftDate, dayPerson);
                    if (!eligibleNight.length) {
                        clinicalStaff.forEach(p => p.weeklyShifts = 0);
                        eligibleNight = getEligibleStaff(clinicalStaff, shiftDate, dayPerson);
                    }
                    const nightPerson = eligibleNight[0];
                    assignments[dateKey].Night = nightPerson.name;

                    // Update counts for both people
                    [dayPerson, nightPerson].forEach(person => {
                        updatePersonCounts(person, shiftDate, isWeekend);
                    });

                    // Reset weekly counts at start of week
                    if (shiftDate.getDay() === 0) {
                        clinicalStaff.forEach(person => person.weeklyShifts = 0);
                    }

                    // Handle transport and control room assignments
                    const ambulanceCount = transportsConfig.ambulance || 0;
                    const medicalTransportCount = transportsConfig.medical || 0;

                    // Get available staff excluding day/night shift staff
                    const transportStaff = getEligibleStaff(people, shiftDate).filter(person =>
                        person !== dayPerson && person !== nightPerson
                    );

                    // Assign control room staff first
                    const controlStaff = transportStaff.find(p => p.roles.includes('ControlRoom'));
                    if (controlStaff) {
                        assignments[dateKey].ControlRoom = controlStaff.name;
                        updatePersonCounts(controlStaff, shiftDate, isWeekend);
                    }

                    // Handle ambulance assignments
                    for (let i = 0; i < ambulanceCount; i++) {
                        const crew = {
                            doctor: transportStaff.find(p => 
                                p.roles.includes('Doctor') && 
                                !assignments[dateKey].Transports.some(t => 
                                    Object.values(t.crew).includes(p.name)
                                )
                            ),
                            medic: transportStaff.find(p => 
                                (p.roles.includes('MedicSenior') || p.roles.includes('MedicTrainee')) && 
                                !assignments[dateKey].Transports.some(t => 
                                    Object.values(t.crew).includes(p.name)
                                )
                            ),
                            driver: transportStaff.find(p => 
                                p.roles.includes('Driver') && 
                                !assignments[dateKey].Transports.some(t => 
                                    Object.values(t.crew).includes(p.name)
                                )
                            )
                        };

                        if (crew.doctor && crew.medic && crew.driver) {
                            assignments[dateKey].Transports.push({
                                type: 'Ambulance',
                                crew: {
                                    Doctor: crew.doctor.name,
                                    Medic: crew.medic.name,
                                    Driver: crew.driver.name
                                }
                            });

                            Object.values(crew).forEach(person => {
                                updatePersonCounts(person, shiftDate, isWeekend);
                            });
                        }
                    }

                    // Handle medical transport assignments
                    for (let i = 0; i < medicalTransportCount; i++) {
                        const crew = {
                            medic: transportStaff.find(p => 
                                (p.roles.includes('MedicSenior') || p.roles.includes('MedicTrainee')) && 
                                !assignments[dateKey].Transports.some(t => 
                                    Object.values(t.crew).includes(p.name)
                                )
                            ),
                            transport: transportStaff.find(p => 
                                p.roles.includes('Transport') && 
                                !assignments[dateKey].Transports.some(t => 
                                    Object.values(t.crew).includes(p.name)
                                )
                            ),
                            driver: transportStaff.find(p => 
                                p.roles.includes('Driver') && 
                                !assignments[dateKey].Transports.some(t => 
                                    Object.values(t.crew).includes(p.name)
                                )
                            )
                        };

                        if (crew.medic && crew.transport && crew.driver) {
                            assignments[dateKey].Transports.push({
                                type: 'MedicalTransport',
                                crew: {
                                    Medic: crew.medic.name,
                                    Transport: crew.transport.name,
                                    Driver: crew.driver.name
                                }
                            });

                            Object.values(crew).forEach(person => {
                                updatePersonCounts(person, shiftDate, isWeekend);
                            });
                        }
                    }

                    // Save assignments and reset counters as needed
                    if (shiftDate.getDay() === 6) { // End of week
                        people.forEach(person => person.weeklyShifts = 0);
                    }

                    saveAssignmentsToStorage();
                }

                // Update UI
                updateCalendar();
                const resultsDiv = document.getElementById('assignmentResults');
                if (resultsDiv) {
                    resultsDiv.textContent = `Configured transports ‚Äî Ambulances/day: ${transportsConfig.ambulance}, Medical transports/day: ${transportsConfig.medical}`;
                }

                alert(`Shifts assigned for ${currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}!`);
                return true;

            } catch (error) {
                console.error('Error assigning shifts:', error);
                alert('An error occurred while assigning shifts: ' + error.message);
                return false;
            }
        }
            const drivers = staff.filter(p => p.roles.includes('Driver'));
            const transports = staff.filter(p => p.roles.includes('Transport'));
            const medics = staff.filter(p => 
                p.roles.includes('MedicSenior') || p.roles.includes('MedicTrainee')
            );

            if (drivers.length && transports.length && medics.length) {
                const crew = {
                    driver: drivers[0],
                    transport: transports[0],
                    medic: medics[0]
                };

                assignments[dateKey].Transports.push({
                    type: 'MedicalTransport',
                    crew: {
                        Driver: crew.driver.name,
                        Transport: crew.transport.name,
                        Medic: crew.medic.name
                    }
                });

                Object.values(crew).forEach(person => {
                    updatePersonCounts(person, date, isWeekend);
                    staff.splice(staff.indexOf(person), 1);
                });
            }
        }

        // Edit staff functions
        function showEditPersonModal(index) {
            const person = people[index];
            
            // Fill the form with current values
            document.getElementById('editPersonName').value = person.name;
            document.getElementById('editEmploymentType').value = person.employmentType;
            document.getElementById('editMaxShiftsPerWeek').value = person.availability.maxShiftsPerWeek;
            document.getElementById('editMinRestDays').value = person.availability.minRestDays;
            document.getElementById('editPersonIndex').value = index;

            // Reset and set checkboxes
            document.getElementsByName('editRoles').forEach(checkbox => {
                checkbox.checked = person.roles.includes(checkbox.value);
            });

            // Show the modal
            document.getElementById('editStaffModal').style.display = 'block';
        }

        function closeEditPersonModal() {
            document.getElementById('editStaffModal').style.display = 'none';
        }

        function updatePerson() {
            const index = parseInt(document.getElementById('editPersonIndex').value);
            const name = document.getElementById('editPersonName').value.trim();
            const employmentType = document.getElementById('editEmploymentType').value;
            const roles = Array.from(document.getElementsByName('editRoles'))
                .filter(checkbox => checkbox.checked)
                .map(checkbox => checkbox.value);

            if (!name || !employmentType) {
                alert('Please provide both name and employment type.');
                return;
            }

            if (roles.length === 0) {
                alert('Please select at least one role.');
                return;
            }

            const maxShiftsPerWeek = parseInt(document.getElementById('editMaxShiftsPerWeek').value) || 4;
            const minRestDays = parseInt(document.getElementById('editMinRestDays').value) || 1;

            // Update the person object
            people[index] = {
                ...people[index],
                name,
                employmentType,
                roles,
                availability: {
                    maxShiftsPerWeek,
                    minRestDays
                }
            };

            // Save changes and update display
            savePeopleToStorage();
            updateStaffTable();
            closeEditPersonModal();
        }

        // Transports configuration (persisted)
        let transportsConfig = { ambulance: 1, medical: 1 };

        function loadTransportsFromStorage() {
            try {
                const saved = localStorage.getItem('transportsConfig');
                if (saved) {
                    transportsConfig = JSON.parse(saved);
                }
            } catch (e) {
                console.error('Failed to load transportsConfig', e);
            }

            // Update UI inputs if present
            const ambEl = document.getElementById('ambulanceCount');
            const medEl = document.getElementById('medicalTransportCount');
            if (ambEl) ambEl.value = transportsConfig.ambulance || 0;
            if (medEl) medEl.value = transportsConfig.medical || 0;
            // Also reflect in assignmentResults if present
            const res = document.getElementById('assignmentResults');
            if (res) res.textContent = `Configured transports ‚Äî Ambulances/day: ${transportsConfig.ambulance}, Medical transports/day: ${transportsConfig.medical}`;
        }

        function saveTransportsToStorage() {
            const amb = parseInt(document.getElementById('ambulanceCount').value) || 0;
            const med = parseInt(document.getElementById('medicalTransportCount').value) || 0;
            transportsConfig = { ambulance: amb, medical: med };
            localStorage.setItem('transportsConfig', JSON.stringify(transportsConfig));
            const res = document.getElementById('assignmentResults');
            if (res) res.textContent = `Configured transports ‚Äî Ambulances/day: ${transportsConfig.ambulance}, Medical transports/day: ${transportsConfig.medical}`;
            alert('Transports configuration saved.');
        }

        // Shift Swap Functions
        function showShiftSwapModal() {
            document.getElementById('shiftSwapModal').style.display = 'block';
            populateSwapStaffSelects();
            initializeDateRange();
            displaySwapRequests();
        }

        function closeShiftSwapModal() {
            document.getElementById('shiftSwapModal').style.display = 'none';
        }

        function initializeDateRange() {
            // Set default date range to next 30 days
            const today = new Date();
            const thirtyDaysLater = new Date(today);
            thirtyDaysLater.setDate(today.getDate() + 30);
            
            document.getElementById('swapDateFrom').value = today.toISOString().split('T')[0];
            document.getElementById('swapDateTo').value = thirtyDaysLater.toISOString().split('T')[0];
        }

        function clearDateRange() {
            document.getElementById('swapDateFrom').value = '';
            document.getElementById('swapDateTo').value = '';
            updateShiftDropdowns();
        }

        function updateShiftDropdowns() {
            // Reload shifts for both staff members if they are selected
            const fromStaff = document.getElementById('swapFromStaff').value;
            const toStaff = document.getElementById('swapToStaff').value;
            
            if (fromStaff) {
                loadStaffShifts('from');
            }
            if (toStaff) {
                loadStaffShifts('to');
            }
        }

        function populateSwapStaffSelects() {
            const fromSelect = document.getElementById('swapFromStaff');
            const toSelect = document.getElementById('swapToStaff');
            
            // Clear existing options except the first one
            fromSelect.innerHTML = '<option value="">' + t('selectStaffMember') + '</option>';
            toSelect.innerHTML = '<option value="">' + t('selectStaffMember') + '</option>';
            
            people.forEach(person => {
                const option1 = document.createElement('option');
                option1.value = person.name;
                option1.textContent = person.name;
                fromSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = person.name;
                option2.textContent = person.name;
                toSelect.appendChild(option2);
            });
        }

        function loadStaffShifts(which) {
            const staffName = which === 'from' 
                ? document.getElementById('swapFromStaff').value 
                : document.getElementById('swapToStaff').value;
            
            const selectId = which === 'from' ? 'swapFromShift' : 'swapToShift';
            const select = document.getElementById(selectId);
            
            // Clear existing shifts
            select.innerHTML = '<option value="">' + t('selectShift') + '</option>';
            
            if (!staffName) return;
            
            // Get date range filter values
            const dateFromInput = document.getElementById('swapDateFrom').value;
            const dateToInput = document.getElementById('swapDateTo').value;
            
            let dateFrom = null;
            let dateTo = null;
            
            if (dateFromInput) {
                dateFrom = new Date(dateFromInput);
                dateFrom.setHours(0, 0, 0, 0);
            }
            if (dateToInput) {
                dateTo = new Date(dateToInput);
                dateTo.setHours(23, 59, 59, 999);
            }
            
            // Find all shifts for this staff member
            const shifts = [];
            Object.keys(assignments).forEach(dateKey => {
                const dayAssignments = assignments[dateKey];
                
                // Parse the date key (format: YYYY-M-D)
                const [year, month, day] = dateKey.split('-').map(Number);
                const shiftDate = new Date(year, month - 1, day);
                
                // Apply date range filter
                if (dateFrom && shiftDate < dateFrom) return;
                if (dateTo && shiftDate > dateTo) return;
                
                if (dayAssignments.Day === staffName) {
                    shifts.push({ date: dateKey, type: 'Day', label: t('dayShift') });
                }
                if (dayAssignments.Night === staffName) {
                    shifts.push({ date: dateKey, type: 'Night', label: t('nightShift') });
                }
                if (dayAssignments.ControlRoom === staffName) {
                    shifts.push({ date: dateKey, type: 'ControlRoom', label: t('controlRoom') });
                }
                if (dayAssignments.Transports) {
                    dayAssignments.Transports.forEach((transport, idx) => {
                        Object.entries(transport.crew).forEach(([role, name]) => {
                            if (name === staffName) {
                                const transportType = transport.type === 'Ambulance' ? t('ambulance') : t('medicalTransport');
                                shifts.push({ 
                                    date: dateKey, 
                                    type: 'Transport', 
                                    label: `${transportType} (${role})`,
                                    transportIndex: idx,
                                    role: role
                                });
                            }
                        });
                    });
                }
            });
            
            // Sort shifts by date
            shifts.sort((a, b) => {
                const [yearA, monthA, dayA] = a.date.split('-').map(Number);
                const [yearB, monthB, dayB] = b.date.split('-').map(Number);
                const dateA = new Date(yearA, monthA - 1, dayA);
                const dateB = new Date(yearB, monthB - 1, dayB);
                return dateA - dateB;
            });
            
            // Add options
            shifts.forEach(shift => {
                const option = document.createElement('option');
                option.value = JSON.stringify(shift);
                option.textContent = `${shift.date} - ${shift.label}`;
                select.appendChild(option);
            });
            
            // Show count of shifts found
            if (shifts.length === 0) {
                const option = document.createElement('option');
                option.disabled = true;
                option.textContent = currentLanguage === 'pl' ? 'Brak zmian w tym zakresie' : 'No shifts in this date range';
                select.appendChild(option);
            }
        }

        function createSwapRequest() {
            const fromStaff = document.getElementById('swapFromStaff').value;
            const fromShiftJson = document.getElementById('swapFromShift').value;
            const toStaff = document.getElementById('swapToStaff').value;
            const toShiftJson = document.getElementById('swapToShift').value;
            const reason = document.getElementById('swapReason').value;
            
            if (!fromStaff || !fromShiftJson || !toStaff || !toShiftJson) {
                alert(currentLanguage === 'pl' ? 'Proszƒô wype≈Çniƒá wszystkie wymagane pola' : 'Please fill in all required fields');
                return;
            }
            
            if (fromStaff === toStaff) {
                alert(currentLanguage === 'pl' ? 'Nie mo≈ºna zamieniƒá zmian z samym sobƒÖ' : 'Cannot swap shifts with yourself');
                return;
            }
            
            const fromShift = JSON.parse(fromShiftJson);
            const toShift = JSON.parse(toShiftJson);
            
            const swapRequest = {
                id: Date.now(),
                fromStaff: fromStaff,
                fromShift: fromShift,
                toStaff: toStaff,
                toShift: toShift,
                reason: reason,
                status: 'pending',
                createdAt: new Date().toISOString()
            };
            
            swapRequests.push(swapRequest);
            saveSwapRequestsToStorage();
            
            // Clear form
            document.getElementById('swapFromStaff').value = '';
            document.getElementById('swapFromShift').innerHTML = '<option value="">' + t('selectShift') + '</option>';
            document.getElementById('swapToStaff').value = '';
            document.getElementById('swapToShift').innerHTML = '<option value="">' + t('selectShift') + '</option>';
            document.getElementById('swapReason').value = '';
            // Reset date range to default
            initializeDateRange();
            
            displaySwapRequests();
            alert(currentLanguage === 'pl' ? 'Pro≈õba o zamianƒô zosta≈Ça utworzona' : 'Swap request created successfully');
        }

        function displaySwapRequests() {
            const container = document.getElementById('swapRequestsList');
            const filter = document.getElementById('swapFilter').value;
            
            container.innerHTML = '';
            
            const filteredRequests = swapRequests.filter(req => {
                if (filter === 'all') return true;
                return req.status === filter;
            });
            
            if (filteredRequests.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">' + 
                    (currentLanguage === 'pl' ? 'Brak pr√≥≈õb o zamianƒô' : 'No swap requests') + '</p>';
                return;
            }
            
            // Sort by date, newest first
            filteredRequests.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            filteredRequests.forEach(request => {
                const div = document.createElement('div');
                div.className = `swap-request ${request.status}`;
                
                const statusLabel = t(request.status);
                const statusColor = request.status === 'pending' ? '#ff9800' : 
                                   request.status === 'approved' ? '#4CAF50' : '#f44336';
                
                div.innerHTML = `
                    <div class="swap-request-header">
                        <span style="color: ${statusColor}; font-weight: bold;">${statusLabel.toUpperCase()}</span>
                        <span style="float: right; font-size: 0.85em; color: #666;">
                            ${new Date(request.createdAt).toLocaleDateString()}
                        </span>
                    </div>
                    <div class="swap-request-details">
                        <strong>${request.fromStaff}</strong> ${t('wants')} 
                        <strong>${request.fromShift.date} (${request.fromShift.label})</strong>
                        <br>
                        ${t('inExchangeFor')} <strong>${request.toStaff}</strong>'s 
                        <strong>${request.toShift.date} (${request.toShift.label})</strong>
                    </div>
                    ${request.reason ? `<div class="swap-request-details"><em>${t('reason')}: ${request.reason}</em></div>` : ''}
                    <div class="swap-request-actions">
                        ${request.status === 'pending' ? `
                            <button onclick="approveSwapRequest(${request.id})" style="background-color: #4CAF50;">${t('approve')}</button>
                            <button onclick="rejectSwapRequest(${request.id})" style="background-color: #f44336;">${t('reject')}</button>
                        ` : ''}
                        <button onclick="deleteSwapRequest(${request.id})" style="background-color: #999;">${t('delete')}</button>
                    </div>
                `;
                
                container.appendChild(div);
            });
        }

        function approveSwapRequest(requestId) {
            const request = swapRequests.find(r => r.id === requestId);
            if (!request) return;
            
            // Perform the swap in assignments
            const fromDate = request.fromShift.date;
            const toDate = request.toShift.date;
            
            // Swap the shifts
            if (request.fromShift.type === 'Transport' || request.toShift.type === 'Transport') {
                // Handle transport swaps carefully
                if (request.fromShift.type === 'Transport') {
                    const transport = assignments[fromDate].Transports[request.fromShift.transportIndex];
                    transport.crew[request.fromShift.role] = request.toStaff;
                }
                if (request.toShift.type === 'Transport') {
                    const transport = assignments[toDate].Transports[request.toShift.transportIndex];
                    transport.crew[request.toShift.role] = request.fromStaff;
                }
            } else {
                // Regular shift swap
                assignments[fromDate][request.fromShift.type] = request.toStaff;
                assignments[toDate][request.toShift.type] = request.fromStaff;
            }
            
            request.status = 'approved';
            saveSwapRequestsToStorage();
            saveAssignmentsToStorage();
            updateCalendar();
            displaySwapRequests();
            
            alert(currentLanguage === 'pl' ? 'Zamiana zatwierdzona i wykonana' : 'Swap approved and completed');
        }

        function rejectSwapRequest(requestId) {
            const request = swapRequests.find(r => r.id === requestId);
            if (!request) return;
            
            request.status = 'rejected';
            saveSwapRequestsToStorage();
            displaySwapRequests();
            
            alert(currentLanguage === 'pl' ? 'Zamiana odrzucona' : 'Swap request rejected');
        }

        function deleteSwapRequest(requestId) {
            if (!confirm(currentLanguage === 'pl' ? 'Czy na pewno usunƒÖƒá tƒô pro≈õbƒô?' : 'Are you sure you want to delete this request?')) {
                return;
            }
            
            swapRequests = swapRequests.filter(r => r.id !== requestId);
            saveSwapRequestsToStorage();
            displaySwapRequests();
        }

        function loadSwapRequestsFromStorage() {
            const saved = localStorage.getItem('swapRequests');
            if (saved) {
                swapRequests = JSON.parse(saved);
            }
        }

        function saveSwapRequestsToStorage() {
            localStorage.setItem('swapRequests', JSON.stringify(swapRequests));
        }

        // Staff Availability Calendar Functions
        function showAvailabilityModal() {
            document.getElementById('availabilityModal').style.display = 'block';
            availabilityDate = new Date(currentDate); // Start with current calendar month
            renderAvailabilityCalendar();
        }

        function closeAvailabilityModal() {
            document.getElementById('availabilityModal').style.display = 'none';
        }

        function previousMonthAvailability() {
            availabilityDate.setMonth(availabilityDate.getMonth() - 1);
            renderAvailabilityCalendar();
        }

        function nextMonthAvailability() {
            availabilityDate.setMonth(availabilityDate.getMonth() + 1);
            renderAvailabilityCalendar();
        }

        function renderAvailabilityCalendar() {
            const year = availabilityDate.getFullYear();
            const month = availabilityDate.getMonth();
            
            // Update month display
            const locale = currentLanguage === 'pl' ? 'pl-PL' : 'en-US';
            document.getElementById('availabilityMonth').textContent = 
                new Date(year, month).toLocaleDateString(locale, { month: 'long', year: 'numeric' });
            
            const filter = document.getElementById('availabilityFilter').value;
            
            // Get days in month
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDay = new Date(year, month, 1).getDay();
            
            // Create table
            let html = '<table class="availability-table"><thead><tr>';
            html += '<th class="staff-name">' + t('staff') + '</th>';
            
            // Add day headers
            const dayHeaders = translations[currentLanguage].days || ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dayOfWeek = date.getDay();
                const dayName = dayHeaders[dayOfWeek].substring(0, 3);
                html += `<th class="day-header"><div class="day-number">${day}</div><div>${dayName}</div></th>`;
            }
            
            html += '</tr></thead><tbody>';
            
            // Get filter setting
            let filteredPeople = [...people];
            
            if (filter !== 'all') {
                // Pre-calculate availability for filtering
                filteredPeople = people.filter(person => {
                    let hasAvailable = false;
                    let hasUnavailable = false;
                    
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dateKey = `${year}-${month + 1}-${day}`;
                        const status = getStaffAvailabilityStatus(person.name, dateKey);
                        
                        if (status === 'available') hasAvailable = true;
                        else hasUnavailable = true;
                    }
                    
                    if (filter === 'available' && hasAvailable) return true;
                    if (filter === 'unavailable' && hasUnavailable && !hasAvailable) return true;
                    
                    return false;
                });
            }
            
            // Add rows for each staff member
            filteredPeople.forEach(person => {
                html += '<tr>';
                html += `<td class="staff-name">${person.name}</td>`;
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const dateKey = `${year}-${month + 1}-${day}`;
                    const dayOfWeek = date.getDay();
                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                    
                    const status = getStaffAvailabilityStatus(person.name, dateKey);
                    let cellClass = 'availability-cell';
                    let title = '';
                    
                    if (status === 'on-leave') {
                        cellClass += ' on-leave';
                        title = t('onLeave');
                    } else if (status === 'scheduled') {
                        cellClass += ' scheduled';
                        const shiftDetails = getStaffShiftDetails(person.name, dateKey);
                        title = `${t('scheduled')}: ${shiftDetails}`;
                    } else {
                        cellClass += ' available';
                        title = t('available');
                        if (isWeekend) {
                            cellClass += ' weekend';
                        }
                    }
                    
                    html += `<td class="${cellClass}" title="${title}">`;
                    if (status === 'scheduled') {
                        html += '‚úì';
                    } else if (status === 'on-leave') {
                        html += '‚úó';
                    }
                    html += '</td>';
                }
                
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            
            if (filteredPeople.length === 0) {
                html = '<p style="text-align: center; padding: 20px; color: #999;">' + 
                    (currentLanguage === 'pl' ? 'Brak personelu do wy≈õwietlenia' : 'No staff to display') + '</p>';
            }
            
            document.getElementById('availabilityGrid').innerHTML = html;
        }

        function getStaffAvailabilityStatus(staffName, dateKey) {
            // Check if on leave
            const [year, month, day] = dateKey.split('-').map(Number);
            const checkDate = new Date(year, month - 1, day);
            
            for (let leave of leaveRecords) {
                if (leave.staffName === staffName) {
                    const leaveStart = new Date(leave.startDate);
                    const leaveEnd = new Date(leave.endDate);
                    
                    if (checkDate >= leaveStart && checkDate <= leaveEnd) {
                        return 'on-leave';
                    }
                }
            }
            
            // Check if scheduled for any shift
            if (assignments[dateKey]) {
                const dayAssignments = assignments[dateKey];
                
                if (dayAssignments.Day === staffName ||
                    dayAssignments.Night === staffName ||
                    dayAssignments.ControlRoom === staffName) {
                    return 'scheduled';
                }
                
                if (dayAssignments.Transports) {
                    for (let transport of dayAssignments.Transports) {
                        if (Object.values(transport.crew).includes(staffName)) {
                            return 'scheduled';
                        }
                    }
                }
            }
            
            return 'available';
        }

        function getStaffShiftDetails(staffName, dateKey) {
            if (!assignments[dateKey]) return '';
            
            const dayAssignments = assignments[dateKey];
            const shifts = [];
            
            if (dayAssignments.Day === staffName) shifts.push(t('dayShift'));
            if (dayAssignments.Night === staffName) shifts.push(t('nightShift'));
            if (dayAssignments.ControlRoom === staffName) shifts.push(t('controlRoom'));
            
            if (dayAssignments.Transports) {
                dayAssignments.Transports.forEach(transport => {
                    Object.entries(transport.crew).forEach(([role, name]) => {
                        if (name === staffName) {
                            const transportType = transport.type === 'Ambulance' ? t('ambulance') : t('medicalTransport');
                            shifts.push(`${transportType} (${role})`);
                        }
                    });
                });
            }
            
            return shifts.join(', ');
        }

        // Work Statistics Functions
        function showStatsModal() {
            document.getElementById('statsModal').style.display = 'block';
            statsDate = new Date(currentDate); // Start with current calendar month
            renderStatsTable();
        }

        function closeStatsModal() {
            document.getElementById('statsModal').style.display = 'none';
        }

        function previousMonthStats() {
            statsDate.setMonth(statsDate.getMonth() - 1);
            renderStatsTable();
        }

        function nextMonthStats() {
            statsDate.setMonth(statsDate.getMonth() + 1);
            renderStatsTable();
        }

        function calculateStaffStats(staffName, year, month) {
            const stats = {
                name: staffName,
                dayShifts: 0,
                nightShifts: 0,
                controlRoom: 0,
                transports: 0,
                totalDays: 0,
                totalHours: 0
            };

            // Define hours per shift type
            const HOURS_PER_DAY_SHIFT = 12;
            const HOURS_PER_NIGHT_SHIFT = 12;
            const HOURS_PER_CONTROL_SHIFT = 12;
            const HOURS_PER_TRANSPORT = 8; // Average for transport shifts

            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let day = 1; day <= daysInMonth; day++) {
                const dateKey = `${year}-${month + 1}-${day}`;
                
                if (assignments[dateKey]) {
                    const dayAssignments = assignments[dateKey];
                    let hasShiftThisDay = false;

                    if (dayAssignments.Day === staffName) {
                        stats.dayShifts++;
                        stats.totalHours += HOURS_PER_DAY_SHIFT;
                        hasShiftThisDay = true;
                    }
                    
                    if (dayAssignments.Night === staffName) {
                        stats.nightShifts++;
                        stats.totalHours += HOURS_PER_NIGHT_SHIFT;
                        hasShiftThisDay = true;
                    }
                    
                    if (dayAssignments.ControlRoom === staffName) {
                        stats.controlRoom++;
                        stats.totalHours += HOURS_PER_CONTROL_SHIFT;
                        hasShiftThisDay = true;
                    }
                    
                    if (dayAssignments.Transports) {
                        dayAssignments.Transports.forEach(transport => {
                            if (Object.values(transport.crew).includes(staffName)) {
                                stats.transports++;
                                stats.totalHours += HOURS_PER_TRANSPORT;
                                hasShiftThisDay = true;
                            }
                        });
                    }

                    if (hasShiftThisDay) {
                        stats.totalDays++;
                    }
                }
            }

            return stats;
        }

        function renderStatsTable() {
            const year = statsDate.getFullYear();
            const month = statsDate.getMonth();
            
            // Update month display
            const locale = currentLanguage === 'pl' ? 'pl-PL' : 'en-US';
            document.getElementById('statsMonth').textContent = 
                new Date(year, month).toLocaleDateString(locale, { month: 'long', year: 'numeric' });
            
            // Calculate stats for all staff
            const allStats = people.map(person => calculateStaffStats(person.name, year, month));
            
            // Calculate summary statistics
            const totalShifts = allStats.reduce((sum, s) => sum + s.dayShifts + s.nightShifts + s.controlRoom + s.transports, 0);
            const totalHours = allStats.reduce((sum, s) => sum + s.totalHours, 0);
            const avgShifts = people.length > 0 ? (totalShifts / people.length).toFixed(1) : 0;
            const avgHours = people.length > 0 ? (totalHours / people.length).toFixed(1) : 0;
            
            // Update summary cards
            document.getElementById('totalShiftsCount').textContent = totalShifts;
            document.getElementById('totalHoursCount').textContent = totalHours;
            document.getElementById('avgShiftsCount').textContent = avgShifts;
            document.getElementById('avgHoursCount').textContent = avgHours;
            
            // Sort based on selected option
            const sortBy = document.getElementById('statsSortBy').value;
            sortStatsData(allStats, sortBy);
            
            // Render table
            const tbody = document.getElementById('statsTableBody');
            tbody.innerHTML = '';
            
            allStats.forEach(stat => {
                const row = document.createElement('tr');
                row.className = 'stats-row';
                row.setAttribute('data-staff-name', stat.name.toLowerCase());
                
                row.innerHTML = `
                    <td style="padding: 10px; border: 1px solid #ddd; font-weight: bold;">${stat.name}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${stat.dayShifts}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${stat.nightShifts}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${stat.controlRoom}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${stat.transports}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: center; background-color: #e3f2fd; font-weight: bold;">${stat.totalDays}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: center; background-color: #f3e5f5; font-weight: bold;">${stat.totalHours}</td>
                `;
                
                tbody.appendChild(row);
            });
            
            if (allStats.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="padding: 20px; text-align: center; color: #999;">' +
                    (currentLanguage === 'pl' ? 'Brak danych' : 'No data available') + '</td></tr>';
            }
        }

        function sortStatsData(stats, sortBy) {
            switch(sortBy) {
                case 'name':
                    stats.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'days-desc':
                    stats.sort((a, b) => b.totalDays - a.totalDays);
                    break;
                case 'days-asc':
                    stats.sort((a, b) => a.totalDays - b.totalDays);
                    break;
                case 'hours-desc':
                    stats.sort((a, b) => b.totalHours - a.totalHours);
                    break;
                case 'hours-asc':
                    stats.sort((a, b) => a.totalHours - b.totalHours);
                    break;
            }
        }

        function filterStatsTable() {
            const searchTerm = document.getElementById('statsSearch').value.toLowerCase();
            const rows = document.querySelectorAll('.stats-row');
            
            rows.forEach(row => {
                const staffName = row.getAttribute('data-staff-name');
                if (staffName.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function exportStatsToCSV() {
            const year = statsDate.getFullYear();
            const month = statsDate.getMonth();
            
            // Calculate stats for all staff
            const allStats = people.map(person => calculateStaffStats(person.name, year, month));
            
            // Sort by name
            allStats.sort((a, b) => a.name.localeCompare(b.name));
            
            // Create CSV content
            let csv = 'Staff,Day Shifts,Night Shifts,Control Room,Transports,Total Days,Total Hours\n';
            
            allStats.forEach(stat => {
                csv += `"${stat.name}",${stat.dayShifts},${stat.nightShifts},${stat.controlRoom},${stat.transports},${stat.totalDays},${stat.totalHours}\n`;
            });
            
            // Add summary row
            const totalShifts = allStats.reduce((sum, s) => sum + s.dayShifts + s.nightShifts + s.controlRoom + s.transports, 0);
            const totalHours = allStats.reduce((sum, s) => sum + s.totalHours, 0);
            csv += `\nTOTAL,,,,,,${totalHours}\n`;
            csv += `AVERAGE,,,,,,${(totalHours / people.length).toFixed(1)}\n`;
            
            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const monthName = new Date(year, month).toLocaleDateString('en-US', { month: 'long' });
            a.href = url;
            a.download = `work_statistics_${monthName}_${year}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Export / Import functions
        function exportData() {
            const payload = {
                people,
                assignments,
                transportsConfig,
                swapRequests
            };
            const dataStr = JSON.stringify(payload, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `shift_planner_export_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        function handleImportFile(e) {
            const file = e.target.files && e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                try {
                    const obj = JSON.parse(evt.target.result);
                    if (obj.people) people = obj.people;
                    if (obj.assignments) assignments = obj.assignments;
                    if (obj.transportsConfig) transportsConfig = obj.transportsConfig;
                    if (obj.swapRequests) swapRequests = obj.swapRequests;
                    savePeopleToStorage();
                    saveAssignmentsToStorage();
                    saveSwapRequestsToStorage();
                    localStorage.setItem('transportsConfig', JSON.stringify(transportsConfig));
                    loadTransportsFromStorage();
                    updateCalendar();
                    updateStaffTable();
                    alert('Import successful.');
                } catch (err) {
                    alert('Import failed: invalid JSON');
                }
            };
            reader.readAsText(file);
            // reset input
            e.target.value = '';
        }

        // Simple in-browser unit tests (run via Run Tests button)
        function runAllTests() {
            const results = [];

            // Backup
            const backupPeople = JSON.parse(JSON.stringify(people));
            const backupAssignments = JSON.parse(JSON.stringify(assignments));
            const backupTransports = JSON.parse(JSON.stringify(transportsConfig));

            try {
                // Test migration
                localStorage.setItem('people', JSON.stringify([{ name: 'Old', role: 'doctor' }]));
                loadPeopleFromStorage();
                const migrated = people[0] && Array.isArray(people[0].roles) && people[0].employmentType;
                results.push({ name: 'Migration test', ok: !!migrated });

                // Test transports persistence
                transportsConfig = { ambulance: 2, medical: 1 };
                localStorage.setItem('transportsConfig', JSON.stringify(transportsConfig));
                transportsConfig = { ambulance: 0, medical: 0 };
                loadTransportsFromStorage();
                results.push({ name: 'Transports persistence', ok: transportsConfig.ambulance === 2 && transportsConfig.medical === 1 });

                // Test assignment respects transport slots
                // Prepare minimal staff
                people = [
                    { name: 'D1', roles: ['Doctor'], availability: { maxShiftsPerWeek: 7, minRestDays: 0 } },
                    { name: 'D2', roles: ['MedicSenior'], availability: { maxShiftsPerWeek: 7, minRestDays: 0 } },
                    { name: 'T1', roles: ['Transport'], availability: { maxShiftsPerWeek: 7, minRestDays: 0 } },
                    { name: 'T2', roles: ['Driver'], availability: { maxShiftsPerWeek: 7, minRestDays: 0 } }
                ];
                // ensure transports config small
                transportsConfig = { ambulance: 1, medical: 0 };
                // set currentDate to a stable month
                const savedDate = new Date(currentDate);
                currentDate = new Date(2025, 10, 1); // November 2025
                assignments = {};
                assignShiftsForCurrentMonth();
                // Check every day assignments Transports length <= slots
                let okAssign = true;
                for (const k in assignments) {
                    const tr = assignments[k].Transports || [];
                    if (tr.length > (transportsConfig.ambulance + transportsConfig.medical)) okAssign = false;
                }
                results.push({ name: 'Assignment transport slot test', ok: okAssign });

                // Restore date
                currentDate = savedDate;

            } catch (e) {
                results.push({ name: 'Exception during tests', ok: false, error: String(e) });
            }

            // Restore backups
            people = backupPeople;
            assignments = backupAssignments;
            transportsConfig = backupTransports;
            savePeopleToStorage();
            saveAssignmentsToStorage();
            localStorage.setItem('transportsConfig', JSON.stringify(transportsConfig));
            loadTransportsFromStorage();

            // Show results
            const okCount = results.filter(r => r.ok).length;
            let msg = `Tests: ${okCount}/${results.length} passed\n`;
            results.forEach(r => msg += `${r.ok ? '‚úî' : '‚úñ'} ${r.name}${r.error ? ' - ' + r.error : ''}\n`);
            alert(msg);
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.className === 'modal') {
                event.target.style.display = 'none';
            }
        };
    </script>
</body>
</html>